#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

#include "lib/sha2.h"
#include "lib/aes.h"

#include "circular_buffer.h"
#include "mp_arithmetic.h"
#include "bbs.h"
#include "gcm.h"
#include "packets.h"
#include "galois_mult.h"
#include "rsa_sig.h"

#define RUN_TEST(test, x, y) {if (is_equal(x,y) == TRUE) { printf(test); printf(" passed!\n"); } else { \
        printf(test); printf(" failed!\n"); printf("Expected: "); print_radix(y); printf("Got: "); print_radix(x);} }
#define RUN_TEST_STR(test, x, y) {if (strcmp(x,y) == 0) { printf(test); printf(" passed!\n"); } else { \
        printf(test); printf(" failed!\n"); printf("Expected: "); printf("%s\n", y); printf("Got: "); printf("%s\n", x);} }
#define RUN_TEST_ARR(test, x, y, bytes) {if (memcmp(x,y,bytes) == 0) { printf(test); printf(" passed!\n"); } else { \
        printf(test); printf(" failed!\n");} }
#define RUN_TEST_BOOL(test, x) {if (x) { printf(test); printf(" passed!\n"); } else { \
        printf(test); printf(" failed!\n");} }

/*#define DEBUG_PRINT*/

uint16_t neg_one[MAX_SIZE] = {0x8, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF};
uint16_t neg_two[MAX_SIZE] = {0x8, 0xFFFE, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF};
uint16_t max_neg[MAX_SIZE] = {0x8, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x8000};
uint16_t max_neg_plus[MAX_SIZE] = {0x8, 0x0001, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x8000};
uint16_t max_neg_twice[MAX_SIZE] = {0x9, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF};
uint16_t max_neg_min[MAX_SIZE] = {0x9, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x7FFF, 0xFFFF};
uint16_t max_pos[MAX_SIZE] = {0x8, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x7FFF};
uint16_t zero[MAX_SIZE] = {0x8, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000};
uint16_t one[MAX_SIZE] = {0x8, 0x0001, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000};
uint16_t two[MAX_SIZE] = {0x8, 0x0002, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000};

uint16_t test_array[MAX_SIZE] = {0};
uint16_t test_array2[MAX_SIZE] = {0};
uint16_t test_array3[MAX_SIZE] = {0};

void test_addition() {
    uint16_t a[MAX_SIZE] = {0x8, 0x4867, 0x3767, 0x2d60, 0xa503, 0x7fe4, 0xa540, 0xc070, 0x67e7};
    uint16_t b[MAX_SIZE] = {0x8, 0x78f9, 0x4952, 0x2293, 0xabbe, 0xb0c7, 0x2fb9, 0xe566, 0x4c4c};
    /* j = a + b */
    uint16_t j[MAX_SIZE] = {0x9, 0xc160, 0x80b9, 0x4ff3, 0x50c1, 0x30ac, 0xd4fa, 0xa5d6, 0xb434, 0x0000};

    mp_add(a, b, test_array);
    RUN_TEST("Addition test a + b", test_array, j);

    mp_add(neg_one, two, test_array);
    RUN_TEST("Addition test -1 + 2", test_array, one);

    mp_add(two, neg_one, test_array);
    RUN_TEST("Addition test 2 + -1", test_array, one);

    mp_add(zero, neg_one, test_array);
    RUN_TEST("Addition test 0 + -1", test_array, neg_one);

    mp_add(max_neg, neg_one, test_array);
    RUN_TEST("Addition test (max neg) + -1", test_array, max_neg_min);

    mp_add(neg_one, max_neg, test_array);
    RUN_TEST("Addition test -1 + (max neg)", test_array, max_neg_min);

    mp_add(max_neg_plus, neg_one, test_array);
    RUN_TEST("Addition test (max neg + 1) + -1", test_array, max_neg);

    mp_add(max_neg, max_neg, test_array);
    RUN_TEST("Addition test (max neg) + (max neg)", test_array, max_neg_twice);

    mp_add(neg_one, neg_one, test_array);
    RUN_TEST("Addition test -1 + -1", test_array, neg_two);

    mp_add(neg_one, one, test_array);
    RUN_TEST("Addition test -1 + 1", test_array, zero);
}

void test_subtraction() {
    uint16_t a[MAX_SIZE] = {0x8, 0x4867, 0x3767, 0x2d60, 0xa503, 0x7fe4, 0xa540, 0xc070, 0x67e7};
    uint16_t b[MAX_SIZE] = {0x8, 0x78f9, 0x4952, 0x2293, 0xabbe, 0xb0c7, 0x2fb9, 0xe566, 0x4c4c};
    /* k = a - b */
    uint16_t k[MAX_SIZE] = {0x8, 0xcf6e, 0xee14, 0x0acc, 0xf945, 0xcf1c, 0x7586, 0xdb0a, 0x1b9a};

    mp_sub(zero, neg_one, test_array);
    RUN_TEST("Subtraction test 0 - -1", test_array, one);

    mp_sub(max_neg, neg_one, test_array);
    RUN_TEST("Subtraction test (max neg) - -1", test_array, max_neg_plus);

    mp_sub(max_neg, one, test_array);
    RUN_TEST("Subtraction test (max neg) - 1", test_array, max_neg_min);

    mp_sub(neg_one, max_neg, test_array);
    RUN_TEST("Subtraction test -1 - (max neg)", test_array, max_pos);

    mp_sub(max_neg_plus, one, test_array);
    RUN_TEST("Subtraction test (max neg + 1) - 1", test_array, max_neg);

    mp_sub(max_neg, max_neg, test_array);
    RUN_TEST("Subtraction test (max neg) - (max neg)", test_array, zero);

    mp_sub(neg_one, neg_one, test_array);
    RUN_TEST("Subtraction test -1 - -1", test_array, zero);

    mp_sub(neg_one, one, test_array);
    RUN_TEST("Subtraction test -1 - 1", test_array, neg_two);

    mp_sub(a, b, test_array);
    RUN_TEST("Subtraction test a - b", test_array, k);
}

void test_multiplication() {
    uint16_t a[MAX_SIZE] = {0x8, 0x4867, 0x3767, 0x2d60, 0xa503, 0x7fe4, 0xa540, 0xc070, 0x67e7};
    uint16_t b[MAX_SIZE] = {0x8, 0x78f9, 0x4952, 0x2293, 0xabbe, 0xb0c7, 0x2fb9, 0xe566, 0x4c4c};
    uint16_t s = 0x2b73;
    /* i = a * b */
    uint16_t i[MAX_SIZE] = {0x10, 0xb42f, 0xdd63, 0xb06d, 0x0758, 0x5f64, 0x8fbe, 0x1be2, 0x03a2,
                            0x7400, 0x74d7, 0xb0f8, 0x81df, 0x9061, 0x5b5a, 0x030a, 0x1ef8};
    /* l = s * a */
    uint16_t l[MAX_SIZE] = {0x9, 0xd345, 0x3c8e, 0x8b87, 0xa90c, 0xdb6d, 0x1174, 0x5e5c, 0x9a6e, 0x11a2};
    uint16_t p[MAX_SIZE] = {0x8, 0xda84, 0xba01, 0xf583, 0xb33d, 0xd97a, 0x865f, 0x57b4, 0x16b8};
    uint16_t p_square[MAX_SIZE] = {0x10, 0x1410, 0x3f8d, 0xfca3, 0x2c34, 0xb016, 0xee8a, 0x6fb, 0x2026, 0xa194, 0x52cb,
                                   0x533, 0x1a54, 0xd5cc, 0x38a5, 0x33d1, 0x204};

    mp_mult(a, b, test_array);
    RUN_TEST("Multiplication test a * b", test_array, i);

    mp_mult_scalar(a, s, test_array);
    RUN_TEST("Multiplication test s * a", test_array, l);

    mp_square(p, test_array);
    RUN_TEST("p*p", test_array, p_square);
}

void test_division() {
    uint16_t a[MAX_SIZE] = {0x8, 0x4867, 0x3767, 0x2d60, 0xa503, 0x7fe4, 0xa540, 0xc070, 0x67e7};
    uint16_t b[MAX_SIZE] = {0x8, 0x78f9, 0x4952, 0x2293, 0xabbe, 0xb0c7, 0x2fb9, 0xe566, 0x4c4c};
    uint16_t m[MAX_SIZE] = {0x7, 0x78fa, 0xe4d2, 0x7165, 0x9ded, 0x9b72, 0x10f1, 0x1d56};
    /* g = a / m  */
    uint16_t g[MAX_SIZE] = {0x2, 0x8ab8, 0x0003};
    /* h = a mod b */
    uint16_t h[MAX_SIZE] = {0x8, 0xcf6e, 0xee14, 0xacc, 0xf945, 0xcf1c, 0x7586, 0xdb0a, 0x1b9a};

    uint16_t x[MAX_SIZE] = {0x200, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 0xc8d3, 0x9efb, 0x0f56, 0xbbaf, 0x9adc, 0xb562, 0xb53c,
                            0x1651, 0x2364, 0xa8a4, 0xaefd, 0xbe48, 0x1dbb, 0xa31c, 0xfb6c, 0xbc21, 0x1ed6, 0x9330,
                            0xaaae, 0x7e0f, 0x81f0, 0xddf0, 0xf3ec, 0x5585, 0xf539, 0x5cc5, 0x85af, 0xa3ac, 0x7cd1,
                            0x6fb1, 0x0666, 0x197d, 0x8f33, 0x90ad, 0x235c, 0xe611, 0x83a1, 0x193f, 0x3d20, 0xd584,
                            0xa932, 0xf5aa, 0xe243, 0x4248, 0x1236, 0x1961, 0x9822, 0x8698, 0x0493, 0xee1d, 0x05f9,
                            0xf00c, 0x382a, 0x4da2, 0x9b96, 0x0184, 0x7069, 0xc5ea, 0xfb60, 0xe137, 0x9e64, 0x389f,
                            0x3df9, 0x4a53, 0x7820, 0xa546, 0x6242, 0xc937, 0x4703, 0x4133, 0x82eb, 0x6783, 0x8c7d,
                            0x7109, 0x5841, 0x6ca7, 0xa53e, 0xe8e4, 0x7f1b, 0xf729, 0xa39e, 0x40e1, 0x81aa, 0x82d0,
                            0x2c70, 0x2ba0, 0x749f, 0x7753, 0x0008, 0x86e5, 0xf918, 0x67b6, 0x43b9, 0x7e86, 0xf7b3,
                            0x1da4, 0x75b6, 0x172e, 0xdc47, 0xa4d2, 0xdac6, 0x239a, 0x7060, 0xfc90, 0xcbec, 0x4d6b,
                            0x308c, 0x411b, 0xc891, 0x0735, 0x9fda, 0x4a88, 0x38cc, 0x20fb, 0x8deb, 0x43a8, 0xa486,
                            0xeef4, 0xbc25, 0x8d18, 0x72bf, 0xbee6, 0x9951, 0xbc27, 0x7897, 0x3b9c, 0xad14, 0x28f6,
                            0x1bd5, 0x66e4, 0xf98e, 0x844a, 0x279b, 0x2567, 0x7a9a, 0x90dc, 0xd7a1, 0xaea4, 0x5322,
                            0xd37b, 0x9f7f, 0x7d15, 0xd35e, 0xa4c0, 0x8529, 0xd12c, 0x20c0, 0xdcaf, 0x180b, 0x5d8d,
                            0x460e, 0x523a, 0xaa63, 0xcddb, 0x0ff4, 0x865b, 0xfe1f, 0x235a, 0xde05, 0x0dae, 0xbfdf,
                            0x2950, 0x78da, 0x3994, 0x5ccf, 0x4511, 0x09b0, 0x11eb, 0x8ae4, 0xb248, 0xd80c, 0x566c,
                            0xb6a9, 0xe5f7, 0xe81c, 0x4d01, 0x7bba, 0xb0fe, 0x9410, 0x7119, 0x1288, 0x184b, 0x36db,
                            0x8763, 0x5a98, 0x10fe, 0x434d, 0x3054, 0x2ba7, 0x8556, 0xce77, 0xcec4, 0xb0ca, 0xfb2a,
                            0xb7d2, 0x67a6, 0x1037, 0xa29b, 0x795f, 0x679a, 0x30d2, 0x734d, 0xfd3c, 0xff43, 0x35bc,
                            0xdaed, 0xf2c5, 0x7697, 0xcf61, 0x0050, 0x18eb, 0xde3c, 0xb5c1, 0xd930, 0x7236, 0x19ce,
                            0xe522, 0x022c, 0x0af9, 0x392f, 0xb105, 0xd28f, 0x665d, 0x5987, 0xb84a, 0x673e, 0x6dd9,
                            0xea4a, 0x5015, 0xcea1, 0xfee5, 0x39da, 0x89eb, 0x4098, 0xb9eb, 0x92ca, 0x7b8b, 0x2fac,
                            0x7f8b, 0x896e, 0x1880, 0xb63f, 0x689e, 0x84a2, 0xb199, 0xe99d, 0xeec6, 0xe7b5, 0x89fb,
                            0x9daf, 0x65d5, 0xb458, 0x60f0, 0x2dcb, 0xd849, 0xae83};
    uint16_t y[MAX_SIZE] = {0x100, 0xffff, 0xffff, 0xffff, 0xffff, 0xad07, 0x0003, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 0xc000, 0x2168, 0xdaa2, 0xc90f,
                            0xffff, 0xffff, 0xffff, 0xffff};
    uint16_t rem[MAX_SIZE] = {0x100, 0x285b, 0xfabd, 0xfd22, 0x04e6, 0x1f12, 0xc6e7, 0xc5ff, 0x3e5c, 0xbf16, 0xbc8d,
                              0xfed8, 0xe37d, 0x01c2, 0x128b, 0xb604, 0xfebb, 0x3365, 0xdd50, 0x7988, 0x3d74, 0xded5,
                              0xfb1e, 0xc7fa, 0x9ee8, 0x5aba, 0x2f9a, 0x6264, 0xcf76, 0xcfb8, 0x4b1f, 0x42d5, 0x2ccf,
                              0xc100, 0x8f57, 0x8f2a, 0xb99c, 0xb5bd, 0x460d, 0x550d, 0x9eaf, 0xb34e, 0xb4a9, 0xc578,
                              0x0c14, 0xe384, 0x7bef, 0x55cf, 0xfd82, 0x0416, 0x6c2e, 0x568c, 0xbf90, 0x1067, 0x5d72,
                              0x78de, 0x6c7a, 0x2664, 0x40e8, 0xe7af, 0x463b, 0x65c6, 0xf9db, 0x6c73, 0x0a8f, 0xde54,
                              0x88e9, 0x240a, 0x4fdb, 0x6d37, 0x0072, 0x5bae, 0x262b, 0xf8c0, 0x5f30, 0x390c, 0x9444,
                              0xc133, 0xa0ad, 0xb5e1, 0x4ef8, 0xe309, 0xccd2, 0x7dda, 0xb4d4, 0xdbda, 0x7261, 0x40a5,
                              0x173d, 0x861b, 0xc287, 0x58e7, 0x6889, 0xf306, 0x82d2, 0x50d1, 0xf2ee, 0x6e42, 0x53c2,
                              0x4331, 0xc768, 0xd57e, 0x2af0, 0x80ed, 0x2f06, 0x7144, 0xaab3, 0x89f4, 0x60f5, 0xf3ba,
                              0x83e5, 0x290f, 0x3587, 0xacca, 0xaef2, 0xfbc7, 0x7bbb, 0xfc24, 0xadd9, 0x5b52, 0x6fc6,
                              0xe892, 0x0d33, 0xb50f, 0xb47e, 0x0c79, 0x146a, 0xce51, 0xdfcd, 0xd505, 0xb746, 0x7925,
                              0x2dc5, 0x0de7, 0x0a6a, 0x5491, 0x03a2, 0x8f0e, 0x9214, 0x55d2, 0xc8a9, 0x1b90, 0xa752,
                              0xdedd, 0xf969, 0x5ecd, 0xcd9c, 0x77dc, 0x9ab4, 0x4e08, 0x8e13, 0x809b, 0x2ae8, 0x9fa5,
                              0x25d1, 0xdc84, 0x64fd, 0x5ab7, 0xecbf, 0xef4e, 0x5009, 0x6853, 0x7806, 0x4cad, 0xd878,
                              0xdae3, 0xf93d, 0xe45b, 0x4383, 0x93d1, 0xe3e8, 0x6dc9, 0x4933, 0xeb23, 0x2033, 0xffca,
                              0xad3d, 0xc641, 0x7c5b, 0xc437, 0x3fcd, 0x3b52, 0x152e, 0xeee1, 0x3b1a, 0xa6d5, 0x84e9,
                              0xfacc, 0xb051, 0x1cf8, 0x9830, 0x6894, 0x3167, 0xeb01, 0xb408, 0xac68, 0xe2f6, 0x48c4,
                              0x767c, 0x71be, 0x83ea, 0xcaff, 0xf0be, 0x7c3d, 0xb7c8, 0x7a8b, 0x82d3, 0xa239, 0xe294,
                              0xab02, 0x6fa4, 0xf55f, 0x9793, 0x1784, 0xc086, 0x46d3, 0xf37a, 0x0795, 0x8cb6, 0xdbad,
                              0xb44e, 0x7e38, 0x0e9f, 0xb3cf, 0x40dd, 0x84c1, 0xd0f2, 0xdea6, 0xf1e3, 0x3fc3, 0xae48,
                              0x9d9c, 0x808f, 0xa642, 0xdcf8, 0xd962, 0xb411, 0xeec9, 0xe600, 0x10a4, 0x41f9, 0xacd6,
                              0xef5b, 0x9b33, 0xbe73, 0x2e88, 0xe330, 0xca12, 0xa707, 0xc9e7, 0x4906, 0x8a05, 0xb034,
                              0x7fcb, 0xec83, 0x54ba, 0x75a2};
    mp_div(a, m, test_array, test_array2);
    RUN_TEST("Division test a / m", test_array, g);

    mp_div(a, b, test_array, test_array2);
    RUN_TEST("Modulo test a mod b", test_array2, h);

    mp_div(x, y, test_array, test_array2);
    RUN_TEST("Modulo test x mod y", test_array2, rem);
}

void test_montgomery() {
    uint16_t p[MAX_SIZE] = {0x8, 0xda84, 0xba01, 0xf583, 0xb33d, 0xd97a, 0x865f, 0x57b4, 0x16b8};
    uint16_t q[MAX_SIZE] = {0x8, 0xcbfa, 0x5c6b, 0x8a92, 0xa8f9, 0xdf4c, 0x9055, 0xdef5, 0x213e};
    uint16_t r[MAX_SIZE] = {0x8, 0xd639, 0xfe13, 0x6b1b, 0xb86c, 0xbd13, 0x1212, 0x7ca7, 0x43e3};
    uint16_t r_prime[MAX_SIZE] = {0x1, 0xC7F7};
    uint16_t R[MAX_SIZE] = {0x9, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0001};
    uint16_t base[MAX_SIZE] = {0x2, 0x0000, 0x0001};

    uint16_t R_square[MAX_SIZE] = {0x11, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
                                   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0001};
    uint16_t pq_mod_r[MAX_SIZE] = {0x8, 0x1008, 0x40d6, 0xbd4b, 0xf112, 0x91b5, 0xd9a3, 0x9163, 0x3cc1};
    uint16_t p_pow_q_mod_r[MAX_SIZE] = {0x8, 0x7380, 0x18ea, 0x7918, 0x9e48, 0x925d, 0x9a0c, 0xe689, 0xd75};
    uint16_t R_square_mod_r[MAX_SIZE] = {0x8, 0xe589, 0x4bda, 0xdad7, 0x4355, 0x3470, 0x7f65, 0x704d, 0x36d3};
    uint16_t R_mod_r[MAX_SIZE] = {0x8, 0x7d55, 0x5c4, 0xbeac, 0xd6ba, 0xc8c4, 0xc9c7, 0x8a0a, 0x3455};

    uint16_t x[MAX_SIZE] = {0x100, 0x7f7e, 0x62ab, 0x313d, 0x9a22, 0xaf69, 0xdb9c, 0x3d08, 0xdf6c, 0xb8b7, 0xbb51,
                            0x91f6, 0xe0c7, 0xbc14, 0xa799, 0xc6f2, 0x8244, 0x0218, 0x4fdd, 0xa852, 0x094c, 0x5333,
                            0x87a5, 0xed68, 0x3e4d, 0x140a, 0x5e14, 0x8fbe, 0xba63, 0xa030, 0x4c55, 0xac04, 0x5721,
                            0x4b22, 0xe85f, 0x7c12, 0x8d2f, 0x07b1, 0xdf44, 0xb008, 0x980d, 0x1365, 0x8c91, 0x5401,
                            0xf2f8, 0x426f, 0x606f, 0xee44, 0xe376, 0xe7c2, 0x1864, 0xfdc0, 0x95fc, 0xc86b, 0x4114,
                            0x01b0, 0x55c0, 0xe8ee, 0x2655, 0xc53b, 0x6f60, 0x5c86, 0xd192, 0xbe27, 0x7ac5, 0xb97e,
                            0x84a2, 0x649c, 0x20fb, 0xbb08, 0xd73d, 0xa570, 0x71f0, 0xe4b8, 0x98da, 0x2336, 0xa439,
                            0x9d28, 0xf9d1, 0x24d7, 0x60c6, 0x4dcc, 0xb08c, 0x4d79, 0x341b, 0xe5af, 0xe58e, 0xb191,
                            0x9357, 0x7dfb, 0xd6fc, 0x92b9, 0x1e84, 0x5ce8, 0x6112, 0x6ee1, 0x46e5, 0x6e5d, 0x1652,
                            0x0af9, 0xa0bd, 0xfb1d, 0x2730, 0x8b72, 0x7701, 0xec2b, 0xe60d, 0x9b11, 0x8132, 0xb038,
                            0x8dda, 0x12b7, 0x7793, 0x1900, 0x2347, 0xbcd3, 0x237a, 0x3661, 0x9cd7, 0xa167, 0x3950,
                            0xff35, 0x14bb, 0x12e7, 0x7967, 0x1e01, 0x542c, 0x73fd, 0xc31b, 0xa37a, 0x4033, 0x094b,
                            0xfde5, 0x834f, 0x8583, 0x2306, 0x2105, 0x3624, 0x18d8, 0x6357, 0xf048, 0x7ee0, 0xeda5,
                            0x2b65, 0x8289, 0xc1a7, 0x70be, 0xeb24, 0x436c, 0x878e, 0x9983, 0xfbdc, 0xcbab, 0xea37,
                            0xba9f, 0xde51, 0x43c2, 0xf506, 0xda33, 0xd184, 0x83ea, 0x3acc, 0xdeb0, 0x497f, 0x226e,
                            0x51b2, 0xa9d1, 0xec24, 0x9fee, 0x7d43, 0xd9a8, 0x09be, 0xc01b, 0x8197, 0x8baf, 0xd2a8,
                            0x22cd, 0x9f7b, 0x8849, 0xeb45, 0x5d87, 0xbc5f, 0x5ab7, 0xbbe5, 0x9a22, 0xb930, 0x7683,
                            0x4b25, 0xb913, 0x4f6c, 0x57f6, 0xe6ad, 0x1fff, 0x21d3, 0xe5bb, 0x3f1e, 0x17bd, 0xf8a6,
                            0x0e56, 0xcd0f, 0x33ef, 0x016e, 0xe6c4, 0x1817, 0xf32a, 0xb62b, 0x7905, 0xb2fa, 0x1a5c,
                            0xc95b, 0x4f1f, 0x7d57, 0xbe2d, 0x7233, 0xef92, 0x4fc5, 0xe9c0, 0xec89, 0x8274, 0xe68d,
                            0x4adb, 0x9020, 0x9464, 0xf772, 0xea63, 0x341c, 0xb5c5, 0x3310, 0xf069, 0x4c42, 0x5ed8,
                            0x66cb, 0xf22a, 0x8e77, 0xb7ab, 0x3f0e, 0xe843, 0x75e9, 0x33f6, 0xc053, 0x75cc, 0x6a20,
                            0xa707, 0xffd8, 0x59bb, 0x67a4, 0x695c, 0x468c, 0x5924, 0xfef6, 0x5bf4, 0xc086, 0xb5d4,
                            0x5b1c, 0xd70e, 0xae5a, 0x74c5};
    uint16_t mod[MAX_SIZE] = {0x100, 0x953b, 0xa4c5, 0x7344, 0x586e, 0x2341, 0xa201, 0x3cb2, 0x8261, 0x069e, 0x5a1f,
                              0x8de7, 0x03e1, 0xe816, 0x743a, 0x26ed, 0xea8d, 0x19b5, 0x8aab, 0xb894, 0x1a4e, 0x826e,
                              0x0196, 0x0abe, 0xe069, 0xab88, 0x88f0, 0x8be6, 0x4537, 0x5ced, 0x7665, 0x9719, 0x5622,
                              0x10d5, 0x116b, 0x380c, 0xc4c7, 0x90ae, 0x168f, 0x86c0, 0xf038, 0xbba1, 0x8e3c, 0xac56,
                              0x02c9, 0x5125, 0xf108, 0xf76b, 0x5389, 0x474d, 0xa04e, 0xbdfa, 0xed73, 0x7130, 0xe965,
                              0xb65f, 0xed2e, 0x6c71, 0x3952, 0xf3d2, 0xaa5f, 0x994b, 0xb529, 0x3f80, 0x4b9c, 0xd574,
                              0xe365, 0x0b91, 0xf5c5, 0xb28d, 0xc0cb, 0x8eed, 0xf19b, 0x4944, 0xb02a, 0xb701, 0x1485,
                              0xd168, 0x4592, 0x0aba, 0xf658, 0xfa61, 0xfd98, 0xbbde, 0x412a, 0xbb62, 0x7607, 0x6be7,
                              0xe3b5, 0x78bc, 0x3763, 0xb564, 0xabf3, 0x0e14, 0x8511, 0xf3e5, 0x3e0f, 0x549e, 0x4d67,
                              0x562e, 0x25c6, 0xbd38, 0x390a, 0xf64b, 0xa3f0, 0xb10e, 0x3e7c, 0x7252, 0x29de, 0x264f,
                              0x2d3e, 0x68b1, 0x1880, 0x6a19, 0x83d9, 0x18c7, 0x8a53, 0x224d, 0x265d, 0x42fe, 0xbccd,
                              0x10a3, 0x4d16, 0x7841, 0xd620, 0x25cb, 0xe383, 0x9b8c, 0xa063, 0xbc17, 0x2ff0, 0xfe08,
                              0x4f54, 0x4256, 0xb24b, 0xe6e3, 0x0553, 0x45c5, 0xf5e0, 0x535a, 0xd77a, 0xd752, 0x95db,
                              0x3374, 0x3cea, 0xa9d0, 0xfc3b, 0x5c19, 0x48f8, 0xdb01, 0xc222, 0xf05a, 0xae9e, 0x1bc9,
                              0x8ae4, 0x3301, 0x45ba, 0xc6b5, 0x5d3c, 0x19fd, 0xf8f3, 0x205c, 0xb040, 0x0f3e, 0x7286,
                              0x3099, 0x9bcf, 0xbc4d, 0x0a12, 0x82c8, 0x39e1, 0x2d57, 0xa40a, 0xd9df, 0xb4ae, 0x9caf,
                              0x5f74, 0xc2df, 0xf728, 0x6947, 0xcec5, 0xca56, 0x62ee, 0xf9da, 0x5cd1, 0x59c2, 0xb4a8,
                              0x0146, 0xbd2b, 0x01a5, 0x4b72, 0x2bb2, 0x0aac, 0xa18f, 0xb07a, 0x7a87, 0x19f7, 0x4571,
                              0x101e, 0x945a, 0xcfe8, 0x30aa, 0x3504, 0xddd9, 0xd222, 0x43b0, 0x1694, 0x1be0, 0x53c1,
                              0xd6e4, 0xad14, 0xfc5a, 0xa5f0, 0x1484, 0xe6a4, 0xecd5, 0x976e, 0xe8fb, 0x5049, 0x26ca,
                              0xce87, 0xca20, 0xed01, 0x363b, 0xb143, 0x0d0e, 0x5b6b, 0xa535, 0x4a85, 0x5de2, 0xc37c,
                              0xc359, 0x440f, 0x4347, 0x324b, 0x869a, 0xc904, 0x97cd, 0x817f, 0xe0b5, 0x55f5, 0xbf68,
                              0xbc66, 0xa772, 0xbe14, 0xea66, 0xf242, 0xeaca, 0x4d88, 0x2077, 0xffc1, 0x1dfa, 0x6e9d,
                              0x3109, 0xb623, 0xf559, 0x7641};
    uint16_t mod_prime[MAX_SIZE] = {0x100, 0x840d, 0x9ebf, 0x088b, 0x6dae, 0x2858, 0x467d, 0x43ff, 0xf924, 0x89c2,
                                    0x1866, 0xcc0c, 0x1db4, 0x2bb6, 0x01a6, 0x8ee8, 0xa75d, 0xa69e, 0x4ba3, 0x8c2e,
                                    0xe3c9, 0xbf20, 0x5a15, 0x037e, 0x698c, 0xa006, 0x2f84, 0xada6, 0x7667, 0xdcad,
                                    0x2b0c, 0xa491, 0xc8ff, 0x5a8a, 0xa4fa, 0x2b6a, 0xed96, 0xa3ba, 0xdd7d, 0x8352,
                                    0x7e0c, 0x8830, 0x3b00, 0x8ef4, 0xc034, 0xe600, 0xba8c, 0x479f, 0x0877, 0x257a,
                                    0x164d, 0x828a, 0xe8bc, 0xbaef, 0x409f, 0xa519, 0xfda0, 0xc856, 0x0a90, 0xcb2e,
                                    0xb2b8, 0xbe98, 0xa416, 0x51c4, 0x9598, 0x6d41, 0xc13c, 0xa5f0, 0xa74a, 0x97ec,
                                    0x753d, 0xcfb5, 0x1245, 0x3a69, 0xd988, 0x0c31, 0xb9e5, 0x8b4a, 0x6a5d, 0xbe0d,
                                    0xd24d, 0xcce5, 0x1621, 0x0005, 0x0bf5, 0x9814, 0x7286, 0xcfe9, 0x7d91, 0xd8ad,
                                    0x906b, 0xa797, 0xa710, 0x81bc, 0x3ac1, 0xa65b, 0x046e, 0x6915, 0x0d84, 0x2eff,
                                    0x6c72, 0x40cf, 0xf6da, 0x0e35, 0x4965, 0xa3fd, 0x21ed, 0x042e, 0x1d82, 0x2df8,
                                    0x575b, 0x1110, 0x8c18, 0xe020, 0x25bf, 0xdb7e, 0x53bd, 0x083d, 0x1e46, 0xe587,
                                    0x86a6, 0xe864, 0xc6e0, 0xe0a0, 0x00c3, 0x573b, 0x1526, 0xb3b7, 0xe788, 0x8ad7,
                                    0x08f3, 0x4c1d, 0x9c9d, 0x7bdd, 0x0469, 0x5e27, 0xa95c, 0x0217, 0xe107, 0xdd47,
                                    0x5ebe, 0x3fe3, 0xc51f, 0x60e7, 0xbf02, 0xd1bd, 0xc069, 0x6985, 0xb5ca, 0x723c,
                                    0x5844, 0xe237, 0x8ddc, 0x9965, 0x916b, 0xad47, 0xee06, 0x05a6, 0xaaae, 0xfec5,
                                    0x086a, 0x5a3c, 0xe956, 0x4cb4, 0x65a3, 0xa2e2, 0x30dd, 0xd5ca, 0xc3d7, 0x3eb7,
                                    0xdcee, 0x6097, 0x4d91, 0x8ce8, 0xd37c, 0x52fb, 0xf98e, 0x8466, 0xbae9, 0x2e98,
                                    0x83c9, 0xae73, 0x1d6f, 0x1650, 0xfc39, 0xad02, 0x29e2, 0xcb00, 0x30cc, 0xee97,
                                    0xb931, 0x0b10, 0xe149, 0x7e8d, 0x75c6, 0x6866, 0x8bb3, 0x8e20, 0xa526, 0xead1,
                                    0xa9d2, 0x15de, 0xe5d5, 0x0823, 0xdc07, 0xb486, 0x40ce, 0xa37b, 0x8dfb, 0xb0f6,
                                    0xa0c9, 0x5b5a, 0x199f, 0xaee0, 0xd990, 0x8d1a, 0x0c75, 0xeb5f, 0x05b3, 0x9935,
                                    0x9db7, 0x73d1, 0x0b0a, 0x0f20, 0xcb63, 0xd895, 0xe2ca, 0x02c1, 0x54ec, 0x0f74,
                                    0xc058, 0x0529, 0xe075, 0x6247, 0x528f, 0x96f3, 0x65b0, 0xd767, 0x9e10, 0xe581,
                                    0xaf5e, 0xee35, 0x9381, 0xfb59, 0x878c, 0x9142, 0x44d0, 0x1221, 0xbe94, 0xb8f7,
                                    0xb35a, 0x3e79, 0x4d4b, 0x72ee, 0xc2af, 0xbb65, 0x77f8};
    uint16_t expected[MAX_SIZE] = {0x100, 0x3d4d, 0x8e45, 0x53ac, 0xad74, 0xfe96, 0x4a4f, 0x7480, 0x7f68, 0xcf2a,
                                   0xc39f, 0x8474, 0x8032, 0x6e0b, 0xea3b, 0x945a, 0x84be, 0x6c87, 0xc516, 0x7594,
                                   0x2430, 0xffd5, 0xce6a, 0x91a7, 0x31ee, 0xb8f1, 0x6291, 0x330a, 0xf5f7, 0x1086,
                                   0xc56a, 0x2c0c, 0x8a70, 0xf333, 0x81b1, 0x4122, 0x8070, 0xd2c6, 0x5081, 0x4828,
                                   0x4cd6, 0x88a4, 0x5cbc, 0xed39, 0xf20d, 0x4209, 0xa70b, 0xe597, 0x010a, 0x9e5d,
                                   0x6922, 0xb57e, 0x2b26, 0x1457, 0x9580, 0xc821, 0xcbee, 0x9b3b, 0xb4c3, 0xa3b7,
                                   0x6651, 0x9da6, 0x51cf, 0x1362, 0x6021, 0x10eb, 0xe222, 0x466f, 0xd4c9, 0xc28c,
                                   0x98ac, 0x8189, 0x6a09, 0xe0a7, 0x776f, 0x5703, 0xdf9c, 0xb552, 0xe4ab, 0x6bc7,
                                   0x8878, 0x2256, 0xa9d2, 0x3fde, 0xa9bd, 0xb0e4, 0x5693, 0x34dc, 0xf91a, 0x0b1a,
                                   0x98a0, 0xc1db, 0x7494, 0x26e5, 0x7a84, 0xea2d, 0x2cdd, 0xa49c, 0xb82c, 0xff5e,
                                   0xf441, 0xef54, 0x06c8, 0xaf21, 0x7e4a, 0xecb0, 0x8e89, 0x2bbc, 0x2250, 0x1d7b,
                                   0xd421, 0x3645, 0x4772, 0x0872, 0x3125, 0x0442, 0x88ee, 0xa1d7, 0x46b3, 0x8352,
                                   0x5963, 0x3505, 0x4085, 0x28f8, 0x8cff, 0x9acc, 0x3dd2, 0xb70a, 0x37b5, 0xaca6,
                                   0xd7b5, 0x20f8, 0x8f60, 0x8fee, 0x454d, 0xd3f4, 0x84a3, 0x7034, 0xf347, 0x68a6,
                                   0xaafa, 0x2118, 0xf016, 0xfb24, 0x9903, 0xb52c, 0x0847, 0x67f9, 0x6153, 0xb3d8,
                                   0xee33, 0x6d8c, 0x206c, 0x6b10, 0xf3c8, 0x12a6, 0xa640, 0x38fc, 0x9e7a, 0x9f14,
                                   0x291d, 0x8bff, 0x9832, 0x7d6d, 0x7c72, 0x1a5a, 0x0c1f, 0x584a, 0x7187, 0x9271,
                                   0x3902, 0x302b, 0xf121, 0x34d3, 0x185d, 0x5872, 0x2b9a, 0x6c42, 0xb3a6, 0x038c,
                                   0x7117, 0x1a15, 0xec0f, 0x9f84, 0xda2e, 0xb0d0, 0x1cb9, 0x771a, 0xb7c6, 0x5530,
                                   0xd866, 0xf2ee, 0xb753, 0x200d, 0x2774, 0xac17, 0x3412, 0x0cdb, 0x4211, 0x717c,
                                   0x7a46, 0x8a5c, 0xd1c1, 0x0252, 0x4e3d, 0xfdac, 0x6af3, 0xe305, 0x15b7, 0xf87d,
                                   0x0359, 0x6f92, 0xba1e, 0xbd97, 0xb341, 0xa6ca, 0x2acc, 0xd7a3, 0x9174, 0x38bd,
                                   0x0cfb, 0x4649, 0x4ef0, 0xc04e, 0x14af, 0x8268, 0xd060, 0x0579, 0x1d93, 0xdab1,
                                   0xc3cb, 0x8191, 0x01de, 0xce6f, 0x6aa2, 0x1b48, 0x0e5e, 0x95c6, 0x9e2a, 0x93b7,
                                   0xe2e5, 0x496f, 0xcde9, 0xda55, 0xbb0d, 0x6e3a, 0x77f1, 0x9341, 0x481c, 0xde32,
                                   0xadd7, 0xa610, 0xd002, 0xc4a6, 0x130c, 0xee3a, 0x3000};
    dh_mon_pro(x, x, mod, mod_prime, test_array);
    RUN_TEST("dh_mon_pro test", test_array, expected);

    /* Test montgomery exponentiation and multiplication */
    mp_square(R, test_array);
    RUN_TEST("R*R", test_array, R_square);

    mp_div(R_square, r, test_array, test_array2);
    RUN_TEST("R*R mod r", test_array2, R_square_mod_r);

    mul_inv(r, base, test_array);
    twos_complement(test_array, test_array2);
    RUN_TEST("r prime", test_array2, r_prime);

    mont_mult(p, q, r, r_prime, test_array);
    mont_mult(R_square_mod_r, test_array, r, r_prime, test_array2);
    RUN_TEST("Montgomery multiplication pq mod r", test_array2, pq_mod_r);

    mont_exp(p, q, r, r_prime, R_mod_r, R, test_array);
    RUN_TEST("Montgomery exponentiation p^q mod r", test_array, p_pow_q_mod_r);
}

void test_sts() {
    /* Shared constants: modulus for Diffie Hellman (and its inverse) and the generator, 2 */
    uint16_t p4096[MAX_SIZE] = {0x100, 0xffff, 0xffff, 0xffff, 0xffff, 0xad07, 0x0003, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                                000000, 000000, 000000, 000000, 000000, 000000, 000000, 0xc000, 0x2168, 0xdaa2, 0xc90f,
                                0xffff, 0xffff, 0xffff, 0xffff};
    uint16_t p4096_g[MAX_SIZE] = {0x1, 0x2};
    uint16_t p4096_prime[MAX_SIZE] = {0x100, 0x0001, 000000, 000000, 000000, 0xad08, 0x0003, 000000, 000000, 0xd040,
                                      0x8323, 0x000d, 000000, 0xc200, 0xbd99, 0xab76, 0x0031, 0x1000, 0x1ae8, 0xd2a4,
                                      0x94d0, 0x80b6, 0xda10, 0xcc07, 0x3ccb, 0x26b8, 0x79a3, 0x3ccd, 0x0357, 0x6d3b,
                                      0x826c, 0x2e88, 0xc539, 0x551f, 0xa0e5, 0x3bac, 0x59d5, 0x70f1, 0x0110, 0x68d0,
                                      0x9b03, 0xaebf, 0x77aa, 0xda69, 0x605f, 0xc2c8, 0x21ab, 0x802a, 0x58d4, 0xa083,
                                      0x6858, 0xdf15, 0xe1be, 0xd19f, 0x08c7, 0xa939, 0xa7f8, 0x3dc9, 0xc3c7, 0xef0e,
                                      0x45cb, 0x2cba, 0x7c58, 0xbe19, 0xcc18, 0x1860, 0xff2a, 0x9edb, 0x5389, 0x913d,
                                      0xb4ec, 0x9fcd, 0x793b, 0xf5fb, 0x3942, 0x2077, 0xf444, 0x0c7b, 0xec45, 0x4134,
                                      0x0d77, 0x04be, 0x310c, 0x9221, 0xc669, 0xbd6f, 0xb5ce, 0x9252, 0x4170, 0xc7d0,
                                      0x9cc9, 0x98de, 0xd55e, 0xbf0c, 0x99c6, 0x0d46, 0x62df, 0x24b3, 0x5a78, 0xed74,
                                      0xfac4, 0x8808, 0x72a8, 0x1c2e, 0xb2fc, 0x420d, 0x114d, 0x9ce9, 0x4b77, 0x6b56,
                                      0x8636, 0x9be1, 0x0781, 0x8e19, 0x3a3f, 0xd962, 0xa608, 0x715f, 0x6f4e, 0xdb2d,
                                      0xb754, 0x204b, 0xd130, 0xdb8e, 0xa44c, 0x5340, 0x7037, 0xd364, 0xa572, 0x35f3,
                                      0xdebf, 0xcb9e, 0x3e9e, 0x46c4, 0xcf4a, 0x55bb, 0xa76d, 0x904f, 0x8071, 0x06d2,
                                      0x1f8e, 0x4cea, 0x7301, 0xf8b5, 0x0b83, 0xfd4e, 0x5fc2, 0xbd67, 0x7552, 0xcac4,
                                      0xbb2f, 0xe63a, 0xccca, 0x7964, 0x85d2, 0x13e4, 0x369d, 0x4fec, 0xd6cb, 0x9f0a,
                                      0x1707, 0xc421, 0x0b21, 0xcfe0, 0xbbd7, 0xc2af, 0x76fb, 0x07eb, 0x25d9, 0x0af6,
                                      0x227e, 0xc3b7, 0xf0e4, 0x20cf, 0x623b, 0x4782, 0x6a8e, 0x5ef8, 0x6975, 0x7f26,
                                      0x514c, 0x1770, 0xb9c2, 0x2ad7, 0xb9c4, 0x9658, 0x3e38, 0x4c8c, 0xdf9c, 0xd59b,
                                      0xf268, 0xe517, 0x8241, 0xa1d0, 0xec74, 0x2eca, 0x4928, 0x7d50, 0x1a70, 0x5d80,
                                      0xfd41, 0x076a, 0x5024, 0xcd30, 0x2eba, 0x8041, 0xf064, 0x0016, 0x1a11, 0x9ace,
                                      0xee93, 0x5258, 0x4ddc, 0x6c41, 0x04a4, 0x77bc, 0x4993, 0x6d3d, 0x870f, 0xdaf0,
                                      0x5bb9, 0xb15d, 0xed05, 0xf7f7, 0x0794, 0xb515, 0x5521, 0x11fd, 0xd022, 0xf586,
                                      0x8fab, 0xc1d7, 0xbd30, 0x3743, 0x92e0, 0x69d7, 0x220b, 0xb88a, 0xc225, 0xb59e,
                                      0x0468, 0x8375, 0xb881, 0x3c9a, 0x06de, 0x3cdd, 0xd441, 0x9d09, 0x1bb6, 0x1927,
                                      0x902b, 0xe424, 0xe601, 0x8a16, 0x01d3, 0x50f2, 0xb2ce};
    uint16_t R[MAX_SIZE] = {0x101, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000, 000000,
                            000000, 000000, 000000, 000000, 0x1};

    /* Constants party A - RSA public (n,e) and private (n,d) keys */
    uint16_t n_A[MAX_SIZE] = {0x100, 0xd3a3, 0xa40c, 0x3342, 0x9b37, 0x05d3, 0x4668, 0xc0ad, 0xa6e0, 0xac23, 0x3455,
                              0x6512, 0xf9bf, 0x2322, 0xd17a, 0x61df, 0x06b1, 0xeaab, 0x343e, 0xd317, 0x288c, 0xd117,
                              0x64c0, 0x8f45, 0xa23e, 0x4674, 0x2a6b, 0x5746, 0xabb4, 0x0a90, 0x95bd, 0xbcc4, 0xf958,
                              0x09c6, 0x8692, 0xe20a, 0xe45d, 0x7c1f, 0xb3a1, 0xdd79, 0x12c6, 0xb451, 0xe060, 0x23eb,
                              0x644e, 0xc57c, 0x344c, 0x28fe, 0x4626, 0xb5f3, 0xf86a, 0x07be, 0x926f, 0xdf6d, 0x8bbe,
                              0x80fa, 0x874f, 0xea72, 0x64d4, 0xb0d1, 0xbb1b, 0xc0bf, 0x84ff, 0xf6ee, 0xed3f, 0x11b7,
                              0x6f67, 0x8858, 0x4736, 0xf565, 0x68f7, 0x4dda, 0xf947, 0xab11, 0xc6d9, 0xc2ff, 0x4209,
                              0xf430, 0xfe1c, 0x08eb, 0xd5b3, 0x85ac, 0x09c6, 0x01d5, 0x8fc0, 0x1df2, 0xfa3c, 0x329f,
                              0xcff8, 0xea36, 0x4f0f, 0xc33e, 0x2e6d, 0x96d8, 0x4343, 0xae39, 0xc652, 0xa958, 0x3aa8,
                              0xbfc9, 0xbeed, 0xb565, 0x2c83, 0x6e4b, 0x620a, 0xd88a, 0x05c0, 0x3fad, 0xfe93, 0x3776,
                              0x9587, 0x9fe9, 0xa0d0, 0x1506, 0x7bf7, 0x20b5, 0x8e04, 0xe7e9, 0x84e2, 0xe4a5, 0x0e56,
                              0x83b1, 0xfde1, 0xa6d4, 0x34dd, 0x6657, 0xebd4, 0x2909, 0x35c7, 0xc759, 0x30cf, 0x4c59,
                              0x2bc1, 0x0d5a, 0x778c, 0x668d, 0xccb0, 0x39c1, 0x70bd, 0x1126, 0xa5c7, 0x8470, 0x795d,
                              0xb5a1, 0x70a7, 0x3562, 0x707f, 0xbf49, 0x1a6b, 0x431d, 0x6b86, 0xb84e, 0xcbb6, 0x991b,
                              0xe754, 0x65eb, 0x567e, 0xe53f, 0x2e4b, 0x1302, 0xcac7, 0xf15a, 0x31ff, 0x5e23, 0xd9a4,
                              0x04e4, 0x00ef, 0xae86, 0x7c5d, 0xf878, 0x577f, 0xcd55, 0x8bb0, 0xc40f, 0xc9f6, 0x1154,
                              0x3d4c, 0x38e5, 0x7376, 0xd04c, 0x552a, 0xa8c2, 0xa576, 0xe16f, 0xa726, 0x3698, 0x67af,
                              0x20d0, 0x9fbb, 0x06d4, 0x086f, 0xdbaa, 0x23a3, 0xd1cb, 0xfb78, 0xa1c8, 0x18e2, 0xf6b6,
                              0xd002, 0x5132, 0x9e6c, 0xb82c, 0x7f09, 0x6555, 0x030a, 0xfdab, 0x5932, 0x7163, 0xec33,
                              0xac4c, 0x3b7f, 0xd62a, 0x5175, 0x1ea0, 0x37d2, 0x3200, 0xbab5, 0x549d, 0x0086, 0x24e4,
                              0x87f4, 0xb116, 0xb48d, 0x98f6, 0xd009, 0xf1ed, 0xda73, 0xf7ed, 0xe49b, 0x6451, 0x980d,
                              0x05f7, 0xde6d, 0xb4ca, 0xc28e, 0x244c, 0xd591, 0xb78a, 0x43b2, 0xc325, 0x3903, 0x17ec,
                              0xd538, 0x5a9d, 0x6535, 0x54c7, 0xe012, 0xb10a, 0x9cad, 0x328c, 0x752a, 0x52fe, 0x41b7,
                              0x07b5, 0xaa75, 0xed62, 0xac7a};
    uint16_t n_A_prime[MAX_SIZE] = {0x100, 0x07f5, 0xa150, 0xa1eb, 0xb7e2, 0xa4c4, 0x8e76, 0x1d8e, 0xc241, 0x3ea5,
                                    0x3373, 0xea0e, 0x58c1, 0xab99, 0x43f3, 0xc150, 0x951f, 0x28d8, 0xe06b, 0x0469,
                                    0xebd0, 0xe2ed, 0xf0c4, 0xe793, 0xc0b6, 0x500c, 0x50f8, 0xc7c8, 0x3740, 0x33e4,
                                    0xb95c, 0xee63, 0x2146, 0xc243, 0x0fb7, 0x0b32, 0x4e9d, 0xa17f, 0xca6b, 0x1066,
                                    0x4419, 0x609e, 0x25bc, 0xcd9b, 0xa331, 0x4e62, 0x516e, 0x087a, 0x4cd8, 0x1fb9,
                                    0x9d44, 0x2126, 0x2ee5, 0x3c60, 0x5017, 0x95f7, 0xd479, 0xfdf0, 0x287b, 0x46bb,
                                    0x931b, 0x2525, 0x88b1, 0x2a79, 0xc17f, 0x4378, 0xfa9e, 0x0dcb, 0x055f, 0xfdb5,
                                    0x0963, 0xc7fe, 0xcc67, 0x4ab6, 0x82b9, 0x3d76, 0x710d, 0x4f5f, 0x74b6, 0x3dbe,
                                    0x9e2d, 0x87b8, 0x7274, 0xc452, 0x86b8, 0xdcf1, 0xdde7, 0xc112, 0xed53, 0x850d,
                                    0xf9ef, 0x96f1, 0x11fa, 0x1d72, 0x625e, 0x5e51, 0xab35, 0x91e2, 0x8cb2, 0x998f,
                                    0xcecb, 0x85fe, 0xc48c, 0x864e, 0x8a1f, 0xb386, 0xddb6, 0x84e3, 0xf623, 0x812b,
                                    0xba56, 0xdfe2, 0x3605, 0x7b0b, 0x0cb3, 0xbc67, 0xf049, 0x0863, 0x3624, 0x2986,
                                    0x82e6, 0xd99b, 0x3065, 0x3ce5, 0x0aa7, 0x7021, 0x6e77, 0x297c, 0xefaa, 0x96cb,
                                    0x6a8c, 0x5323, 0x0e6c, 0x4249, 0xd342, 0x8eb4, 0xd1e0, 0xc304, 0x7fb9, 0x3601,
                                    0xae15, 0xf08c, 0x1330, 0x5bbd, 0xb6d6, 0x3dbf, 0x37af, 0x22c9, 0x920b, 0xc726,
                                    0xa97c, 0x29f7, 0xdcf7, 0x709a, 0x5bd2, 0xa2be, 0x345d, 0x4d99, 0x8754, 0xe5de,
                                    0x33a0, 0x3667, 0xf25a, 0x5e0f, 0x0d34, 0xc5ce, 0xcf4f, 0xba73, 0x52dd, 0x60f9,
                                    0xa9d6, 0xaa20, 0xca8b, 0xf20d, 0x48a6, 0x44e2, 0xcc91, 0x5e71, 0x0bc3, 0xb84d,
                                    0xdcd1, 0x51de, 0xafed, 0x26d3, 0x82e4, 0x2bfa, 0x47a6, 0x9d98, 0xa766, 0x937c,
                                    0x564a, 0x7268, 0xd048, 0x4d5b, 0x446e, 0xa864, 0xff07, 0xe3ea, 0x62f5, 0x0339,
                                    0x3a28, 0x8e6d, 0xa746, 0xc9aa, 0x9c47, 0xe0f2, 0xc23f, 0x6186, 0xda38, 0x77eb,
                                    0xf365, 0x733b, 0x1cd0, 0xaf7b, 0x3356, 0x9c04, 0x049e, 0x18e4, 0xc551, 0xb41b,
                                    0xd41f, 0x3198, 0xce28, 0x2f83, 0xd295, 0x3d4d, 0xcb14, 0xbccc, 0x5f76, 0x62e7,
                                    0x9e7b, 0x4ff6, 0x1455, 0xeb22, 0xe33b, 0x8f91, 0x799b, 0x63ca, 0x842d, 0x7bde,
                                    0x951c, 0x7932, 0x6e4e, 0xb111, 0x879a, 0x13b4, 0x26b7, 0xcc11, 0x5ae7, 0x0615,
                                    0xd085, 0xacdc, 0xbb1f, 0x5625, 0x88f5, 0xecc3, 0x23f6};
    uint16_t e_A[MAX_SIZE] = {0x1, 0x5};
    uint16_t d_A[MAX_SIZE] = {0x100, 0x4c85, 0x5e2f, 0xfb60, 0x7bd3, 0x5e3b, 0x7d1d, 0xee40, 0xd464, 0xea1c, 0xec4d,
                              0xa099, 0x3f4a, 0xe43d, 0xafa7, 0x7c63, 0x1f08, 0xcb18, 0x498c, 0x18ba, 0x296f, 0x751e,
                              0xba96, 0x237e, 0x5ab9, 0xdec8, 0x1046, 0x5b6c, 0x3020, 0xe446, 0xf1d9, 0x839c, 0x8cdd,
                              0x83dc, 0x07eb, 0x88ca, 0xf403, 0x8757, 0x998e, 0xf28a, 0x58be, 0xbdd6, 0xcba3, 0x3081,
                              0x34d8, 0x55af, 0xc5b9, 0x37ec, 0x2bc4, 0x93ad, 0xb396, 0x7b24, 0x6fbb, 0x761b, 0xb3be,
                              0x0402, 0xb6dd, 0x768b, 0x2390, 0xd0e5, 0xb9f8, 0x2b36, 0x460b, 0xd890, 0xb6bc, 0x7d32,
                              0xd260, 0x0dd9, 0xdc7a, 0xbbb7, 0x8f9b, 0xb747, 0x030e, 0xda16, 0x94de, 0x3a94, 0x556d,
                              0x8240, 0xc15a, 0x9735, 0xb0ec, 0x4748, 0x5339, 0x7b2a, 0x9aa4, 0xa62d, 0x5adb, 0xe50d,
                              0x8915, 0x4fdf, 0xe17a, 0x72c8, 0x2168, 0xfa3c, 0xbb78, 0x1383, 0xc631, 0xf647, 0x8048,
                              0xaf3c, 0xed90, 0x9207, 0x0aee, 0x7acc, 0x9361, 0xfe6d, 0x378f, 0xb813, 0xb05a, 0x96ab,
                              0x3b0b, 0xdedc, 0x9bcb, 0x4285, 0xd6da, 0xa05b, 0xf537, 0x40a1, 0x1b67, 0xf0b6, 0x9280,
                              0x7df0, 0x88f5, 0x19e7, 0x82a8, 0x408b, 0xd626, 0xf244, 0xd4d8, 0xf4aa, 0xd68f, 0xdc11,
                              0xa259, 0x02ab, 0x4b1c, 0xae1c, 0xc289, 0xa526, 0x7cf2, 0x69d4, 0xbac1, 0xe749, 0x1845,
                              0xbded, 0xe354, 0xa446, 0xe34c, 0x2641, 0x6baf, 0x409f, 0x1581, 0xbe76, 0xc257, 0xb838,
                              0xc7dd, 0x7ac8, 0x114c, 0xc773, 0x6fa8, 0x3700, 0x288e, 0xfd12, 0x09ff, 0x4607, 0x2b87,
                              0x9a94, 0xccfc, 0x561a, 0xe5ac, 0x64e4, 0x77e6, 0x8f77, 0x8256, 0x5a69, 0xf531, 0x9d10,
                              0x3f75, 0x3e94, 0xb0b1, 0xf675, 0x776e, 0x21c0, 0x877e, 0x6049, 0x54a1, 0x0aeb, 0x7b23,
                              0x6cf6, 0x5325, 0x9af7, 0xce7c, 0x2bee, 0x6d87, 0x29f5, 0xff18, 0xb9f4, 0x9e93, 0x3157,
                              0x299a, 0xdd0a, 0xb948, 0x24d5, 0xe635, 0xaddd, 0x009b, 0x65ef, 0x783d, 0x16ad, 0xc8d7,
                              0x2275, 0xd8b3, 0xc46e, 0x104a, 0x0620, 0x0b2a, 0x0a00, 0xbef1, 0x7752, 0x99b4, 0xd42d,
                              0x1b30, 0x569e, 0x241c, 0x84fe, 0x299b, 0x96c9, 0xf87d, 0x3195, 0x941f, 0x4743, 0x519c,
                              0xcdfe, 0xc615, 0x575b, 0x26e9, 0xa0dc, 0x2ab6, 0xf182, 0xda56, 0x8d6d, 0x71cd, 0x9e62,
                              0xf771, 0x7885, 0xadd7, 0x10f4, 0xc66a, 0x569b, 0x85bc, 0x7082, 0xb108, 0x76ff, 0xd9f1,
                              0x34bd, 0xeee4, 0xfc46, 0x227e};

    /* Constants party B - RSA public (n,e) and private (n,d) keys */
    uint16_t n_B[MAX_SIZE] = {0x100, 0x953b, 0xa4c5, 0x7344, 0x586e, 0x2341, 0xa201, 0x3cb2, 0x8261, 0x069e, 0x5a1f,
                              0x8de7, 0x03e1, 0xe816, 0x743a, 0x26ed, 0xea8d, 0x19b5, 0x8aab, 0xb894, 0x1a4e, 0x826e,
                              0x0196, 0x0abe, 0xe069, 0xab88, 0x88f0, 0x8be6, 0x4537, 0x5ced, 0x7665, 0x9719, 0x5622,
                              0x10d5, 0x116b, 0x380c, 0xc4c7, 0x90ae, 0x168f, 0x86c0, 0xf038, 0xbba1, 0x8e3c, 0xac56,
                              0x02c9, 0x5125, 0xf108, 0xf76b, 0x5389, 0x474d, 0xa04e, 0xbdfa, 0xed73, 0x7130, 0xe965,
                              0xb65f, 0xed2e, 0x6c71, 0x3952, 0xf3d2, 0xaa5f, 0x994b, 0xb529, 0x3f80, 0x4b9c, 0xd574,
                              0xe365, 0x0b91, 0xf5c5, 0xb28d, 0xc0cb, 0x8eed, 0xf19b, 0x4944, 0xb02a, 0xb701, 0x1485,
                              0xd168, 0x4592, 0x0aba, 0xf658, 0xfa61, 0xfd98, 0xbbde, 0x412a, 0xbb62, 0x7607, 0x6be7,
                              0xe3b5, 0x78bc, 0x3763, 0xb564, 0xabf3, 0x0e14, 0x8511, 0xf3e5, 0x3e0f, 0x549e, 0x4d67,
                              0x562e, 0x25c6, 0xbd38, 0x390a, 0xf64b, 0xa3f0, 0xb10e, 0x3e7c, 0x7252, 0x29de, 0x264f,
                              0x2d3e, 0x68b1, 0x1880, 0x6a19, 0x83d9, 0x18c7, 0x8a53, 0x224d, 0x265d, 0x42fe, 0xbccd,
                              0x10a3, 0x4d16, 0x7841, 0xd620, 0x25cb, 0xe383, 0x9b8c, 0xa063, 0xbc17, 0x2ff0, 0xfe08,
                              0x4f54, 0x4256, 0xb24b, 0xe6e3, 0x0553, 0x45c5, 0xf5e0, 0x535a, 0xd77a, 0xd752, 0x95db,
                              0x3374, 0x3cea, 0xa9d0, 0xfc3b, 0x5c19, 0x48f8, 0xdb01, 0xc222, 0xf05a, 0xae9e, 0x1bc9,
                              0x8ae4, 0x3301, 0x45ba, 0xc6b5, 0x5d3c, 0x19fd, 0xf8f3, 0x205c, 0xb040, 0x0f3e, 0x7286,
                              0x3099, 0x9bcf, 0xbc4d, 0x0a12, 0x82c8, 0x39e1, 0x2d57, 0xa40a, 0xd9df, 0xb4ae, 0x9caf,
                              0x5f74, 0xc2df, 0xf728, 0x6947, 0xcec5, 0xca56, 0x62ee, 0xf9da, 0x5cd1, 0x59c2, 0xb4a8,
                              0x0146, 0xbd2b, 0x01a5, 0x4b72, 0x2bb2, 0x0aac, 0xa18f, 0xb07a, 0x7a87, 0x19f7, 0x4571,
                              0x101e, 0x945a, 0xcfe8, 0x30aa, 0x3504, 0xddd9, 0xd222, 0x43b0, 0x1694, 0x1be0, 0x53c1,
                              0xd6e4, 0xad14, 0xfc5a, 0xa5f0, 0x1484, 0xe6a4, 0xecd5, 0x976e, 0xe8fb, 0x5049, 0x26ca,
                              0xce87, 0xca20, 0xed01, 0x363b, 0xb143, 0x0d0e, 0x5b6b, 0xa535, 0x4a85, 0x5de2, 0xc37c,
                              0xc359, 0x440f, 0x4347, 0x324b, 0x869a, 0xc904, 0x97cd, 0x817f, 0xe0b5, 0x55f5, 0xbf68,
                              0xbc66, 0xa772, 0xbe14, 0xea66, 0xf242, 0xeaca, 0x4d88, 0x2077, 0xffc1, 0x1dfa, 0x6e9d,
                              0x3109, 0xb623, 0xf559, 0x7641};
    uint16_t n_B_prime[MAX_SIZE] = {0x100, 0x840d, 0x9ebf, 0x088b, 0x6dae, 0x2858, 0x467d, 0x43ff, 0xf924, 0x89c2,
                                    0x1866, 0xcc0c, 0x1db4, 0x2bb6, 0x01a6, 0x8ee8, 0xa75d, 0xa69e, 0x4ba3, 0x8c2e,
                                    0xe3c9, 0xbf20, 0x5a15, 0x037e, 0x698c, 0xa006, 0x2f84, 0xada6, 0x7667, 0xdcad,
                                    0x2b0c, 0xa491, 0xc8ff, 0x5a8a, 0xa4fa, 0x2b6a, 0xed96, 0xa3ba, 0xdd7d, 0x8352,
                                    0x7e0c, 0x8830, 0x3b00, 0x8ef4, 0xc034, 0xe600, 0xba8c, 0x479f, 0x0877, 0x257a,
                                    0x164d, 0x828a, 0xe8bc, 0xbaef, 0x409f, 0xa519, 0xfda0, 0xc856, 0x0a90, 0xcb2e,
                                    0xb2b8, 0xbe98, 0xa416, 0x51c4, 0x9598, 0x6d41, 0xc13c, 0xa5f0, 0xa74a, 0x97ec,
                                    0x753d, 0xcfb5, 0x1245, 0x3a69, 0xd988, 0x0c31, 0xb9e5, 0x8b4a, 0x6a5d, 0xbe0d,
                                    0xd24d, 0xcce5, 0x1621, 0x0005, 0x0bf5, 0x9814, 0x7286, 0xcfe9, 0x7d91, 0xd8ad,
                                    0x906b, 0xa797, 0xa710, 0x81bc, 0x3ac1, 0xa65b, 0x046e, 0x6915, 0x0d84, 0x2eff,
                                    0x6c72, 0x40cf, 0xf6da, 0x0e35, 0x4965, 0xa3fd, 0x21ed, 0x042e, 0x1d82, 0x2df8,
                                    0x575b, 0x1110, 0x8c18, 0xe020, 0x25bf, 0xdb7e, 0x53bd, 0x083d, 0x1e46, 0xe587,
                                    0x86a6, 0xe864, 0xc6e0, 0xe0a0, 0x00c3, 0x573b, 0x1526, 0xb3b7, 0xe788, 0x8ad7,
                                    0x08f3, 0x4c1d, 0x9c9d, 0x7bdd, 0x0469, 0x5e27, 0xa95c, 0x0217, 0xe107, 0xdd47,
                                    0x5ebe, 0x3fe3, 0xc51f, 0x60e7, 0xbf02, 0xd1bd, 0xc069, 0x6985, 0xb5ca, 0x723c,
                                    0x5844, 0xe237, 0x8ddc, 0x9965, 0x916b, 0xad47, 0xee06, 0x05a6, 0xaaae, 0xfec5,
                                    0x086a, 0x5a3c, 0xe956, 0x4cb4, 0x65a3, 0xa2e2, 0x30dd, 0xd5ca, 0xc3d7, 0x3eb7,
                                    0xdcee, 0x6097, 0x4d91, 0x8ce8, 0xd37c, 0x52fb, 0xf98e, 0x8466, 0xbae9, 0x2e98,
                                    0x83c9, 0xae73, 0x1d6f, 0x1650, 0xfc39, 0xad02, 0x29e2, 0xcb00, 0x30cc, 0xee97,
                                    0xb931, 0x0b10, 0xe149, 0x7e8d, 0x75c6, 0x6866, 0x8bb3, 0x8e20, 0xa526, 0xead1,
                                    0xa9d2, 0x15de, 0xe5d5, 0x0823, 0xdc07, 0xb486, 0x40ce, 0xa37b, 0x8dfb, 0xb0f6,
                                    0xa0c9, 0x5b5a, 0x199f, 0xaee0, 0xd990, 0x8d1a, 0x0c75, 0xeb5f, 0x05b3, 0x9935,
                                    0x9db7, 0x73d1, 0x0b0a, 0x0f20, 0xcb63, 0xd895, 0xe2ca, 0x02c1, 0x54ec, 0x0f74,
                                    0xc058, 0x0529, 0xe075, 0x6247, 0x528f, 0x96f3, 0x65b0, 0xd767, 0x9e10, 0xe581,
                                    0xaf5e, 0xee35, 0x9381, 0xfb59, 0x878c, 0x9142, 0x44d0, 0x1221, 0xbe94, 0xb8f7,
                                    0xb35a, 0x3e79, 0x4d4b, 0x72ee, 0xc2af, 0xbb65, 0x77f8};
    uint16_t e_B[MAX_SIZE] = {0x1, 0x0007};
    uint16_t d_B[MAX_SIZE] = {0x100, 0xc81f, 0xa58d, 0x02c3, 0x135f, 0x6b7e, 0x7948, 0xaf4c, 0x9209, 0x826a, 0xa2eb,
                              0x6ca6, 0x1379, 0xbaea, 0x6439, 0x0633, 0xc80c, 0x3699, 0x143c, 0x5abd, 0xc8b5, 0xf577,
                              0xf48d, 0xf0df, 0x884b, 0xa25c, 0xa50b, 0xd85c, 0x7747, 0xadee, 0x21e6, 0x44d4, 0x8e46,
                              0x252e, 0x3df9, 0xbded, 0x983f, 0x5381, 0x9b82, 0x3611, 0xd09e, 0xd260, 0x54f8, 0xee1a,
                              0x3b3f, 0xe564, 0x0807, 0x38f3, 0x2ce9, 0x16e7, 0x1a54, 0x2958, 0xe632, 0x8936, 0x4337,
                              0x8edd, 0x587d, 0x9927, 0xc822, 0xd794, 0x5cf3, 0x98c2, 0x026b, 0x61ab, 0xd2e2, 0x19d0,
                              0xcab0, 0x9fba, 0xae8f, 0x9060, 0x2588, 0x2e6f, 0xaadb, 0x2cb8, 0x6f21, 0xe447, 0xb4e7,
                              0xfb4d, 0xb7dd, 0xe54b, 0xd663, 0xe74b, 0xd72e, 0x21ad, 0xf8b5, 0x20a2, 0xc15f, 0x23c1,
                              0x52a8, 0x71f2, 0xda44, 0xde6b, 0xe69b, 0xe1d8, 0x5208, 0xff78, 0x85a4, 0xdcb4, 0x3964,
                              0x4cb0, 0x6f42, 0x3af9, 0x66fa, 0x1500, 0x0f32, 0xb29d, 0xe3bc, 0xc888, 0x186a, 0x3ed7,
                              0xa6f6, 0xdec6, 0x2b91, 0x5195, 0x0ed1, 0x7853, 0x40aa, 0x8b09, 0xc2ae, 0xdc98, 0x594a,
                              0x19bf, 0xe5ef, 0x6363, 0xc6fb, 0x903e, 0x1326, 0x3c80, 0x6a21, 0xad27, 0xbdb4, 0xdb25,
                              0x5479, 0x2e0c, 0xf4e6, 0x20fb, 0x2555, 0x531c, 0x47b2, 0x799f, 0xb111, 0x1ec2, 0x5e8d,
                              0x507e, 0x51d8, 0x1842, 0x6d2d, 0x9f71, 0x0a6c, 0xfab7, 0xae04, 0x6b7a, 0x3d84, 0x03f8,
                              0x5cfc, 0x0749, 0x09f6, 0x1c63, 0x31e4, 0xdf24, 0xda6b, 0x2931, 0xd009, 0x26bf, 0x7e13,
                              0x993a, 0xcd1d, 0x3f78, 0x6f27, 0x5bd3, 0x5169, 0x98c3, 0xce4a, 0x8cd6, 0xf53d, 0xf1cf,
                              0x0da2, 0x4069, 0x47e1, 0x0f0a, 0xafd3, 0x8a9e, 0xc4fd, 0x4843, 0xe8b0, 0x3164, 0x3e61,
                              0x4953, 0xad4f, 0xb717, 0x53eb, 0x2ad0, 0x6f3d, 0x1714, 0x1936, 0x1181, 0xba91, 0x9c34,
                              0x9496, 0xa77a, 0xaffc, 0x74aa, 0x50b7, 0x1fb1, 0xb04e, 0x9bf4, 0x70f0, 0x03fb, 0x0bf7,
                              0xb0fc, 0x8670, 0x6d31, 0xf322, 0x4c12, 0xd7ce, 0xd8b0, 0xf10f, 0xd823, 0x549c, 0xe0f8,
                              0x8b37, 0xd3bb, 0xb424, 0x2c51, 0xd02e, 0x266f, 0x7ac6, 0x60be, 0x0aa5, 0x568e, 0xae36,
                              0xd2c3, 0xe526, 0xc077, 0xbe0a, 0xa583, 0xaf00, 0x15af, 0xa4c9, 0xfb87, 0x30d9, 0xada1,
                              0x640e, 0x6110, 0x88de, 0xb3c5, 0x9052, 0x8f41, 0x0b13, 0xe011, 0x6dad, 0x0448, 0xeb3b,
                              0x5025, 0x3e97, 0xd9e8, 0x10e4};

    /* 256 bit random exponents for key generation */
    uint16_t x[MAX_SIZE] = {0x10, 0x18d0, 0xcda2, 0x7f45, 0xf535, 0x8436, 0xb73f, 0x883a, 0xf635, 0x3206, 0x4e28,
                            0xe3a3, 0x11b7, 0x7fe8, 0x9500, 0xfd19, 0x0ca2};
    uint16_t y[MAX_SIZE] = {0x10, 0x6bc0, 0x29fd, 0x6a79, 0xa5d6, 0x2fa8, 0x4836, 0x56ed, 0xee14, 0xc99b, 0x4862,
                            0x3d66, 0xf945, 0x2365, 0x94ce, 0x505e, 0x1e14};

    uint16_t two_pow_x_expected[MAX_SIZE] = {0x100, 0x3fe6, 0x9843, 0xdac9, 0x65ba, 0xac74, 0x6ddb, 0x5edb, 0xd3b9,
                                             0x11ba, 0xfa89, 0x8fe8, 0x502d, 0x87c1, 0x3097, 0x06d6, 0x61bb, 0xbc7f,
                                             0x0a70, 0xb2bc, 0x1e63, 0x588f, 0x881c, 0xc236, 0xb716, 0xee55, 0xbda0,
                                             0xe910, 0xc90b, 0x0f74, 0x6310, 0xa969, 0xbd98, 0x889a, 0x9914, 0x320f,
                                             0xfa38, 0x5707, 0x5ff0, 0xce97, 0x3f21, 0xbfa0, 0xd7c7, 0x3d5e, 0x9c85,
                                             0xb6d2, 0xa9be, 0xee02, 0x93ca, 0x4ad5, 0xd7a8, 0xdbd1, 0xd323, 0x6f46,
                                             0xb84b, 0x6ae2, 0x8586, 0x9259, 0x3fc7, 0x27d4, 0xf294, 0x1858, 0x4557,
                                             0x9634, 0x1d86, 0x53c5, 0x039f, 0x76d3, 0x1bc2, 0x1bc5, 0xf073, 0x6217,
                                             0xe637, 0x8b1c, 0x3568, 0xd0f7, 0x87e2, 0x4cf2, 0x933b, 0x1548, 0x6acf,
                                             0x9b79, 0xa2b5, 0x37f0, 0x1a7f, 0x4b27, 0xe1d0, 0x9222, 0xcd7f, 0x7f11,
                                             0xc497, 0x769e, 0x9500, 0xa9f1, 0x511d, 0xaf5a, 0x7401, 0xa9b0, 0x692e,
                                             0x8761, 0x1e75, 0xf0e0, 0xc38c, 0xaa38, 0xdf2d, 0xe640, 0xf44c, 0x03f0,
                                             0x95e9, 0x12c4, 0xdb82, 0x96a5, 0xf46d, 0x2ea4, 0x9e40, 0x6c63, 0x0061,
                                             0xd86b, 0x3788, 0xe059, 0x46ab, 0x2442, 0xa8f6, 0x14e2, 0x9fda, 0xd459,
                                             0x4a72, 0x7399, 0xe528, 0xf5a7, 0x9d9d, 0xda3e, 0xe7a8, 0x7a53, 0xc77d,
                                             0xe750, 0x5886, 0xab9b, 0x229c, 0x6df8, 0x3a55, 0x9920, 0x90e0, 0x044a,
                                             0x1ec7, 0x368e, 0x8da5, 0x17c6, 0x73b0, 0x84d8, 0x68af, 0x3511, 0x37de,
                                             0xc9cf, 0x05f6, 0x830f, 0x0ef4, 0x8938, 0xd972, 0x1a95, 0x06fa, 0xdfe0,
                                             0x26de, 0x7123, 0x4dfd, 0xb85c, 0x06fd, 0x2d9a, 0x3a27, 0x1c85, 0x22f5,
                                             0x061d, 0x167b, 0x7e68, 0x23ba, 0xd1af, 0x3f2d, 0xf7c9, 0x4000, 0xfa47,
                                             0xd50e, 0xab05, 0x89c1, 0x2ee8, 0x7e62, 0x5a7a, 0xcf32, 0x0c55, 0xe786,
                                             0x9671, 0x9b50, 0xb0c4, 0xf680, 0xd3e5, 0x261e, 0x2f13, 0x6223, 0x3f0c,
                                             0x7dfa, 0xdeb3, 0x5ad8, 0xf988, 0x2a2a, 0xbb9d, 0xea82, 0x5423, 0xee7c,
                                             0xedc5, 0x2325, 0x0314, 0x0e91, 0x60ad, 0x0aca, 0x8af8, 0xe3d4, 0xbd2b,
                                             0x6f21, 0xaed9, 0x1f7e, 0xc9b6, 0xc7cf, 0x4a6f, 0x7028, 0xa45b, 0x9903,
                                             0x388b, 0x3617, 0x900d, 0x4b3f, 0x6c93, 0x5614, 0xf3bb, 0x4bf7, 0xb4e5,
                                             0x34b9, 0xd947, 0x5c25, 0xfa76, 0x535b, 0x9161, 0xac30, 0x9d1e, 0x782a,
                                             0x910a, 0x2499, 0x54bb, 0xa4df, 0xb6b4, 0xfb8a, 0x5900, 0x84e1, 0xb6b3,
                                             0xa889, 0x2d7d, 0x599d, 0xa68f, 0xe221};
    uint16_t two_pow_y_expected[MAX_SIZE] = {0x100, 0xadc7, 0xaad3, 0xc141, 0xe9cb, 0x8466, 0xeba6, 0xce38, 0xa94e,
                                             0x74c5, 0x3e94, 0xf79a, 0x7b38, 0x6c11, 0xa9d1, 0xa240, 0x7560, 0x7ed2,
                                             0xbed8, 0x6df3, 0xc29e, 0x263c, 0xbb4b, 0xadff, 0xbc8d, 0x26a2, 0x79a9,
                                             0x3b16, 0xfb65, 0x2720, 0xfa49, 0x800b, 0x15b0, 0x3ebc, 0x2590, 0x247d,
                                             0x82d5, 0xd9df, 0x04fe, 0x6595, 0x73f8, 0xda52, 0x9e55, 0x3305, 0x1aff,
                                             0x2cd4, 0x3872, 0x01be, 0x9cd4, 0x719f, 0x22d4, 0x51c0, 0x5137, 0xf068,
                                             0x5ebb, 0x856b, 0x2950, 0x9e04, 0x86f3, 0x6c31, 0x1f28, 0x3c82, 0xb72e,
                                             0xa696, 0xc338, 0x5d21, 0xb55c, 0xecf0, 0xa078, 0xf971, 0x2e3b, 0xe421,
                                             0xb79c, 0xcb48, 0x86cc, 0x0c25, 0x4232, 0x6e7f, 0x8274, 0x593d, 0x299b,
                                             0xfcc5, 0x9f0b, 0xcd2a, 0x20dc, 0xaef5, 0x18ec, 0xf013, 0xbaad, 0xd6d7,
                                             0x21f5, 0x52d3, 0x87bd, 0x26e6, 0xf8d0, 0x3199, 0xabd2, 0x7075, 0x7b87,
                                             0xcc15, 0x4f80, 0x7bcc, 0xf5de, 0xe297, 0x0268, 0x23dd, 0x800e, 0xda38,
                                             0xf16c, 0xc5bc, 0x408a, 0xf282, 0x603e, 0xade0, 0x9df1, 0x5b8c, 0xbccb,
                                             0xf7b2, 0x75b6, 0x1c18, 0x8a4a, 0x2d4a, 0xb0e4, 0xd8ff, 0xe232, 0x2068,
                                             0x0d22, 0xda92, 0x6062, 0x26c8, 0x291c, 0x3a9c, 0xd4fe, 0x5a80, 0xb728,
                                             0x2e97, 0xc143, 0x2d84, 0x82d9, 0xc4a8, 0xc950, 0xdccd, 0x0cb8, 0xc04e,
                                             0x3b87, 0x46fd, 0xb6be, 0x2857, 0x05cc, 0xe9a6, 0xbca3, 0xa3dd, 0x2a56,
                                             0x0527, 0x30fe, 0x6654, 0x6bc6, 0xf720, 0xa35e, 0x9461, 0xdc8d, 0x3fef,
                                             0x3a3e, 0x54af, 0xb3bc, 0x0a62, 0x396c, 0xc4cb, 0x583c, 0xced8, 0x243e,
                                             0x468b, 0x854f, 0x4270, 0xe4ba, 0xbcc0, 0x1514, 0xcec7, 0xf5eb, 0xfd34,
                                             0x7628, 0xf9ed, 0xdf0a, 0x348c, 0xc5bd, 0x892d, 0x0cea, 0x15e5, 0x2b4e,
                                             0xac98, 0x3e97, 0x0847, 0x8f8d, 0x7937, 0xbf3b, 0xdb26, 0x8747, 0x441d,
                                             0x9a10, 0x2b87, 0x5cfe, 0x7d47, 0xdf30, 0xc8b0, 0xafe2, 0xc4a8, 0x1d88,
                                             0x6e4b, 0xe69a, 0xd566, 0x6afe, 0x9a41, 0xc7b8, 0xfc5e, 0xd9cf, 0xc019,
                                             0xccd5, 0x0d64, 0xd590, 0xe5c2, 0x9414, 0x98e2, 0xc4a8, 0x1a06, 0xc4d9,
                                             0x6930, 0x1357, 0xbc60, 0x9abc, 0x6aef, 0x5eb8, 0x2477, 0x0b47, 0x889a,
                                             0xa114, 0xdafa, 0x4173, 0x77ba, 0x4102, 0xf67e, 0x3c08, 0x3aee, 0x610f,
                                             0xbd9d, 0x0802, 0x26e0, 0xfc24, 0xa3bf, 0xd01e, 0xf1fc, 0x8760, 0x0651,
                                             0x8358, 0x72fc, 0xf8df, 0xcaa8, 0xa339};
    uint8_t key_expected[SHA256_DIGEST_LENGTH +
                         1] = "\xd6\xdd\x8a\x9e\x38\xcf\xaf\x5b\x27\xe7\x4e\xba\x72\xce\x08\xd6\x91\xb6\xd9\x8b\xe5\x53\xb6\xdd\x73\xb0\x72\x17\x6a\xe3\x48\xca";

    /* Buffers */
    uint16_t two_pow_x[MAX_SIZE] = {0};
    uint16_t two_pow_y[MAX_SIZE] = {0};
    uint16_t ss_A[MAX_SIZE] = {0};
    uint16_t ss_B[MAX_SIZE] = {0};
    uint16_t sig_A[MAX_SIZE] = {0};
    uint16_t sig_B[MAX_SIZE] = {0};
    uint16_t sig_A_decrypted[MAX_SIZE] = {0};
    uint16_t sig_B_decrypted[MAX_SIZE] = {0};
    uint8_t key_A[SHA256_DIGEST_LENGTH + 1] = {0};
    uint8_t key_B[SHA256_DIGEST_LENGTH + 1] = {0};
    uint8_t cipher_text_A[33][16] = {{0}};
    uint8_t cipher_text_B[33][16] = {{0}};

    /* Encryption */
    aes_key key;

    SHA256_CTX ctx;
    uint8_t *buf;
    uint16_t i;

    /* STEP a). A send B message 1 (a^x mod p) */
    dh_mon_exp(p4096_g, x, p4096, p4096_prime, R, two_pow_x);
    RUN_TEST("a^x mod p test", two_pow_x, two_pow_x_expected);

    /* STEP b). Compute shared key. Sign concatenation of exponentials.
     * Send B message 2. (a^y mod p, Ek(Sb(a^y, a^x)) */
    dh_mon_exp(p4096_g, y, p4096, p4096_prime, R, two_pow_y);
    RUN_TEST("a^y mod p test", two_pow_y, two_pow_y_expected);

    dh_mon_exp(two_pow_x, y, p4096, p4096_prime, R, ss_B);
    buf = (uint8_t *) &ss_B[1];
    SHA256_Init(&ctx);
    SHA256_Update(&ctx, buf, 512);
    SHA256_Final(key_B, &ctx);
    RUN_TEST_STR("Diffie-Hellman key test (B)", (const char *) key_B, (const char *) key_expected);

    pkcs_sign(n_B, n_B_prime, d_B, R, two_pow_y, two_pow_x, sig_B);
    /* encrypt sig_B */
    aes_set_encrypt_key(&key, (const uint8_t *) key_B, 128);
    for (i = 0; i < 33; i++) {
        aes_encrypt(&key, (uint8_t *) (sig_B + i * 8), cipher_text_B[i]);
    }
    /* STEP c). A compute shared key. Decrypt encrypted data.
     * Verify signature. Send B encrypted signature. */
    dh_mon_exp(two_pow_y, x, p4096, p4096_prime, R, ss_A);
    buf = (uint8_t *) &ss_A[1];
    SHA256_Init(&ctx);
    SHA256_Update(&ctx, buf, 512);
    SHA256_Final(key_A, &ctx);
    RUN_TEST_STR("Diffie-Hellman key test (A)", (const char *) key_A, (const char *) key_expected);
    aes_set_encrypt_key(&key, (const uint8_t *) key_A, 128);
    for (i = 0; i < 33; i++) {
        aes_decrypt(&key, cipher_text_B[i], (uint8_t *) (sig_B_decrypted + i * 8));
    }
    /* RSA verification */
    RUN_TEST_BOOL("Signature verification test (A verify B's signature)",
                  pkcs_verify(n_B, n_B_prime, e_B, R, two_pow_y, two_pow_x, sig_B_decrypted));

    pkcs_sign(n_A, n_A_prime, d_A, R, two_pow_x, two_pow_y, sig_A);
    /* encrypt sig_A */
    aes_set_encrypt_key(&key, (const uint8_t *) key_A, 128);
    for (i = 0; i < 33; i++) {
        aes_encrypt(&key, (uint8_t *) (sig_A + i * 8), cipher_text_A[i]);
    }
    aes_set_encrypt_key(&key, (const uint8_t *) key_B, 128);
    for (i = 0; i < 33; i++) {
        aes_decrypt(&key, cipher_text_A[i], (uint8_t *) (sig_A_decrypted + i * 8));
    }
    /* STEP d). B decrypt encrypted data and verify signature */
    RUN_TEST_BOOL("Signature verification test (B verify A's signature)",
                  pkcs_verify(n_A, n_A_prime, e_A, R, two_pow_x, two_pow_y, sig_A_decrypted));
}

void test_bbs() {
    uint16_t seed[MAX_SIZE] = {0x8, 0x9831, 0x8a91, 0x8e70, 0xec39, 0xf491, 0x92a1, 0xf919, 0x6d5b};
    uint16_t bbs_expected[MAX_SIZE] = {0x10, 0x81c1, 0x0101, 0xc71e, 0xa542, 0x2451, 0x5a2f, 0x1655, 0x9ac0, 0x170d,
                                       0xa52a, 0x24cf, 0x79e7, 0xd59f, 0xbe6c, 0x8747, 0x209a};
    uint16_t bbs_out[MAX_SIZE] = {0};
    uint16_t length = 256; /* bits */
    bbs(seed, length, bbs_out);
    RUN_TEST("Blum-blum-shub PRNG", bbs_out, bbs_expected);
}

void test_square_mod_n() {
    uint16_t x[MAX_SIZE] = {0x100, 0x290d, 0x9f2a, 0xd76c, 0x18ae, 0xf8d9, 0xd136, 0x9899, 0x0b44, 0x9f78, 0x3c8b,
                            0x3bf9, 0x019c, 0x9d5c, 0x6ff9, 0x0724, 0x5b3b, 0xbc64, 0x8af9, 0x803d, 0x0e7e, 0x35e1,
                            0x235d, 0x0c32, 0xabb0, 0xcede, 0x410c, 0x0afc, 0xd85a, 0xd3e5, 0xeac3, 0x5e5e, 0x5485,
                            0x681e, 0x8161, 0x5ecb, 0xd206, 0xf208, 0x0f16, 0xf217, 0xcabe, 0xe63a, 0xf93e, 0x31ea,
                            0x1183, 0xb7db, 0x9254, 0xce83, 0x50ff, 0x30ee, 0x510f, 0xc315, 0x7d68, 0x5c21, 0x4da9,
                            0x04e1, 0xafdd, 0x2588, 0x302f, 0x3369, 0xa3c7, 0x4cd5, 0x080a, 0x1abc, 0x23fc, 0x96de,
                            0x1a43, 0x87e0, 0x1a9a, 0x7f3e, 0x54b8, 0xa5cc, 0x33ec, 0x8439, 0x6dc2, 0x9329, 0x0eb7,
                            0xfd59, 0x907b, 0xd21f, 0xdf85, 0x8d15, 0xf351, 0x7a84, 0x68f8, 0xd25f, 0x5b8f, 0xb189,
                            0xa0c1, 0x74dc, 0xe11e, 0x748e, 0xc946, 0xe74c, 0x1614, 0xfd7c, 0xfc6f, 0x614c, 0x0a61,
                            0xdaa8, 0x8a79, 0xcf01, 0xd01d, 0xeb55, 0x7d26, 0x618e, 0x9ffb, 0x0d90, 0x946d, 0xbd3d,
                            0x4934, 0x6ecf, 0xdb29, 0x8fb4, 0xe5c7, 0x18fc, 0x8c92, 0x92b3, 0x579d, 0x97dc, 0x1de6,
                            0x205d, 0xe056, 0xd397, 0x252a, 0xbf9e, 0x0f6f, 0xdbbf, 0x9184, 0x79e0, 0x1098, 0x3459,
                            0xa856, 0xe265, 0x7f11, 0x4492, 0x96cf, 0xc720, 0x10a9, 0xa9ae, 0x9204, 0x7d00, 0x3fcd,
                            0x52bf, 0x9a62, 0xc7d6, 0x8ba0, 0xf3b3, 0xa3ce, 0xa211, 0x081c, 0xecd3, 0x50a1, 0x3728,
                            0x3f86, 0x7450, 0xfb03, 0xc503, 0x1889, 0x79b8, 0x3000, 0xcc07, 0xe48b, 0x8504, 0x629d,
                            0x49a8, 0x0d83, 0x625e, 0x4fd4, 0xbf8f, 0x4227, 0x3245, 0xa72b, 0x55d1, 0xd8b8, 0xf06a,
                            0x98fe, 0x9c8e, 0xbf80, 0xa8d9, 0x7fa7, 0xb05c, 0xf154, 0xa95b, 0x333d, 0x5c04, 0x9d14,
                            0xab23, 0xa991, 0x6467, 0x9a93, 0x08f9, 0xb6f9, 0x009d, 0x7375, 0x9ed1, 0x666b, 0xf256,
                            0x8262, 0x0d18, 0xd8b9, 0xdf8b, 0x0f53, 0x9207, 0x8cf4, 0x5989, 0xd276, 0xc1db, 0xad12,
                            0x4e86, 0x1ea7, 0x6db5, 0x5390, 0x9bab, 0xda70, 0x7222, 0xf0ec, 0x7ace, 0x0b75, 0xe730,
                            0x551d, 0xa399, 0x93a3, 0x6a58, 0x18c8, 0x52a7, 0x287f, 0x8e3e, 0x5550, 0x1ec5, 0x49fc,
                            0xc71a, 0xea7b, 0xeca7, 0xb799, 0xb409, 0x315a, 0xeffe, 0x70cc, 0x19c5, 0x834a, 0xb334,
                            0x842f, 0x9e19, 0x151b, 0x4ba3, 0xc582, 0xf93c, 0x6783, 0x1c9e, 0xbabb, 0x26c5, 0x2012,
                            0x7710, 0x0c84, 0x8cf6, 0xa1f8};
    uint16_t n[MAX_SIZE] = {0x100, 0xe375, 0x66a4, 0xfa4e, 0xd3b1, 0x6665, 0x78a5, 0x1e68, 0xaff5, 0xfb04, 0x8b7f,
                            0x3444, 0x2071, 0x85f7, 0xa84f, 0x34bd, 0xc8fd, 0x4846, 0xfd04, 0x404f, 0xcfd7, 0x471f,
                            0x4d97, 0xe8ca, 0x8c5e, 0xc2f7, 0x6dd7, 0xd97e, 0x442d, 0x796e, 0xeb49, 0x0597, 0xd58e,
                            0xe680, 0x4964, 0xbc2f, 0xd26a, 0x8927, 0xc22d, 0x5eb4, 0x14ab, 0xc6ee, 0x6c3b, 0x72ea,
                            0x2525, 0x2a9d, 0x09eb, 0x924b, 0x8a09, 0x12e6, 0x080c, 0xa975, 0x6401, 0xaf10, 0x5b31,
                            0xe881, 0x9f4c, 0x5765, 0xdb38, 0xea9b, 0x1302, 0x3370, 0xd56e, 0x7b26, 0x996d, 0x4db1,
                            0x5de8, 0x05a2, 0x9c8a, 0x52a3, 0x4f0b, 0x409f, 0x3876, 0xaf88, 0x1af9, 0x1c2a, 0xecdc,
                            0x3c84, 0x2027, 0x5442, 0x38c0, 0x53b8, 0xae19, 0xfd69, 0xa18e, 0x6c1d, 0x0a91, 0x2cd6,
                            0x3c0a, 0xa1a4, 0x5472, 0x02a0, 0x8f0c, 0x1d0d, 0x64db, 0x7913, 0x3b91, 0x0ca9, 0xcd54,
                            0x0b06, 0x495f, 0x5059, 0xa24f, 0x8cc2, 0xe3a8, 0xcac1, 0x2d2b, 0xf272, 0x82ba, 0x1334,
                            0x492d, 0x4839, 0x014f, 0xf0fc, 0x1b26, 0x208c, 0x536e, 0x5a59, 0x42ed, 0xcae9, 0x3a9f,
                            0x97c9, 0x51cf, 0xdb4a, 0x928f, 0x2725, 0xe747, 0x54c9, 0xb9ff, 0x8671, 0x8229, 0xb9dd,
                            0x3a76, 0x9802, 0xd048, 0x6047, 0x717d, 0xc9d3, 0x3f95, 0x6475, 0xba49, 0xc81f, 0x1b36,
                            0x8e9c, 0xa2b5, 0x95ea, 0x70ef, 0x18de, 0x7cbd, 0x92bb, 0xe35e, 0x4fa0, 0xc75b, 0x95d9,
                            0x6fe3, 0x24f0, 0x7a3b, 0x9582, 0xa808, 0x625a, 0xab2a, 0x3008, 0x0d40, 0xb4d9, 0x3b8b,
                            0x71d6, 0xcc11, 0x6080, 0x7350, 0x7af1, 0xc2ae, 0xb92f, 0x5138, 0x351b, 0xc97d, 0x318f,
                            0x4b9c, 0xb221, 0xb59e, 0xe39a, 0xb239, 0x09f8, 0x7a92, 0xeaf2, 0xf9eb, 0xdc2f, 0x1d28,
                            0x5e0a, 0x1b47, 0x1a51, 0xa4d8, 0xf7f0, 0xfe5c, 0xde46, 0x4b8d, 0x6901, 0xc637, 0x9a93,
                            0xa7fd, 0x522f, 0x00e8, 0x1e0c, 0x08ce, 0x10ab, 0xe188, 0xa1cb, 0xf73b, 0x7e1e, 0xf324,
                            0x34ee, 0x3441, 0xe829, 0xd6a9, 0x606f, 0xadc8, 0x667e, 0x24ee, 0x6127, 0xbb1a, 0xe6f6,
                            0x575a, 0x9072, 0xac56, 0xa623, 0xde00, 0x0f06, 0xf2a4, 0x4494, 0x9637, 0x1e7f, 0x2923,
                            0x8ba2, 0xf0a3, 0x33c8, 0x0e95, 0x90da, 0xcba6, 0x4b20, 0x8d6d, 0xcdca, 0x0915, 0x3e71,
                            0xf884, 0x9090, 0x9df2, 0xbcff, 0xe01b, 0x2323, 0x8f95, 0xd7f6, 0x2ac7, 0x86de, 0xa9dd,
                            0x4055, 0x4344, 0xc84d, 0xdae9};
    uint16_t out[MAX_SIZE] = {0};
    uint16_t square[MAX_SIZE] = {0};
    uint16_t temp[MAX_SIZE] = {0};
    uint16_t expected_square[MAX_SIZE] = {0x200, 0x2aa9, 0xa4d9, 0xdee7, 0xbd27, 0xae7b, 0xfb46, 0x68af, 0x17ef, 0x8a65,
                                          0x929c, 0x8a31, 0x4081, 0x8434, 0x4f9f, 0x2cf6, 0x9736, 0xb42f, 0xdf05,
                                          0x9792, 0xf57b, 0xbacf, 0x4bcf, 0x37e0, 0xabac, 0x3abe, 0x85da, 0x0996,
                                          0x2e54, 0x24bf, 0x7757, 0xef5a, 0xe0aa, 0xb23a, 0x7870, 0x7550, 0x7708,
                                          0xc50a, 0xa1f9, 0x1528, 0x7dff, 0x4d67, 0x4eda, 0x45ad, 0xa32c, 0x8c68,
                                          0x5471, 0x6d6d, 0x7bd2, 0xaca5, 0x84fe, 0x1202, 0xc7e8, 0x3ad5, 0x46b8,
                                          0xa3e1, 0x507e, 0xe73d, 0x37c8, 0x66b1, 0x2b34, 0x4415, 0xb393, 0x4e3d,
                                          0x01cd, 0xb5b7, 0x3f3a, 0x1d83, 0xbe85, 0xaaa3, 0xe5ca, 0x60a0, 0x6350,
                                          0xa8e4, 0x42a8, 0x8d4b, 0x1735, 0xeb5c, 0x8d4f, 0x2126, 0xe2fa, 0xdd91,
                                          0xce12, 0x480d, 0xdc42, 0x0671, 0x92f4, 0xda5e, 0x69da, 0x18ce, 0x6c8f,
                                          0xb75f, 0x12b7, 0x9747, 0xca32, 0x77ff, 0xf452, 0x576e, 0xb8fe, 0xb722,
                                          0x3ddb, 0x7d9f, 0x47c6, 0xaf57, 0xc027, 0xaa15, 0xd2eb, 0x70d9, 0x2c07,
                                          0x404f, 0xf8cd, 0x1995, 0x50c0, 0xf16f, 0x7b0d, 0x8902, 0x739b, 0x4641,
                                          0x6ac8, 0x1deb, 0x5b74, 0x50ef, 0xb6a6, 0x44fa, 0xb18d, 0x9153, 0x274a,
                                          0x5d11, 0x0b46, 0x5ce3, 0xc779, 0x0380, 0x4407, 0xf086, 0x07a3, 0x9b13,
                                          0xeeaf, 0xb273, 0x2537, 0x1b40, 0x91ac, 0x910d, 0x7938, 0xff47, 0xf628,
                                          0x3a15, 0xd7af, 0x8646, 0x2ca2, 0x85d2, 0xf043, 0x9787, 0x70c1, 0xe4ce,
                                          0x9446, 0x2aab, 0xc3fd, 0xdb81, 0xa191, 0x3f14, 0x8b61, 0xa8df, 0xcce8,
                                          0x424d, 0xaaaf, 0xd01c, 0x2123, 0x79bc, 0x0358, 0x33c4, 0x3216, 0xd81d,
                                          0x66d4, 0x0167, 0x509f, 0x909b, 0xa38c, 0x0aa8, 0x1591, 0xc092, 0x13f8,
                                          0x1563, 0xfa8a, 0xf5f3, 0x31da, 0x9751, 0xc1de, 0xccdc, 0x35bd, 0x3b58,
                                          0x74a8, 0xf67e, 0xe6bf, 0xd4e2, 0xb434, 0x7041, 0x4250, 0x4827, 0xccd3,
                                          0x3a65, 0x0b6a, 0x33bc, 0xc913, 0x4522, 0xa5e4, 0x6cff, 0x165a, 0x6f39,
                                          0xea7f, 0xfbb3, 0xe3c4, 0x4ee1, 0xdfaa, 0xa671, 0xcf84, 0x89d9, 0x4c6c,
                                          0x3264, 0xc246, 0x5d35, 0x26d7, 0xd9fc, 0xdb3d, 0x23f9, 0xa574, 0x016d,
                                          0x00be, 0xc851, 0x99e5, 0xfc0f, 0xdc0f, 0x89f4, 0xec89, 0xaa3c, 0x78b6,
                                          0x8b94, 0xa24f, 0xc8a5, 0x9b81, 0x23ac, 0x6724, 0x17c3, 0xac01, 0x2e89,
                                          0xc777, 0x7e85, 0xc676, 0xad2b, 0xd89e, 0xf6ba, 0x4554, 0x740a, 0x788d,
                                          0xac45, 0xda95, 0xb898, 0x4dad, 0x8836, 0xfdc2, 0x8863, 0x922f, 0x8529,
                                          0xbd82, 0x8365, 0x16a5, 0xc777, 0xec2a, 0x4d4e, 0x914f, 0x4169, 0xbf29,
                                          0xa85f, 0x090f, 0x6f9f, 0xbd04, 0xa2b9, 0xa7f9, 0x80b0, 0x9d58, 0xfe9d,
                                          0x54b0, 0x4670, 0x474a, 0x9928, 0xfdd2, 0xf77b, 0xdf35, 0x020b, 0xf891,
                                          0x4c69, 0xcfd6, 0x2c28, 0x5a14, 0x244c, 0x09d2, 0xdd30, 0xffc6, 0xedcf,
                                          0x6435, 0x8425, 0x8496, 0xba90, 0x7ba5, 0x63bc, 0x27b3, 0x46c0, 0x270b,
                                          0x6ffc, 0x167d, 0x4825, 0x875c, 0x0379, 0x5f12, 0xeb12, 0x5b65, 0xd106,
                                          0x5906, 0x4e71, 0xf1f5, 0xe62e, 0xd0c9, 0x2eb6, 0x6b24, 0xdf9b, 0x8f60,
                                          0x013d, 0xde81, 0xab96, 0x3dd1, 0x04d5, 0xadf6, 0x4698, 0x57ab, 0xf199,
                                          0x659b, 0xbfda, 0xbf7b, 0x73db, 0xf70c, 0x7dea, 0xb323, 0xa152, 0x0c7f,
                                          0xf46f, 0xc755, 0xa10d, 0x2ac9, 0x31e6, 0xdee8, 0x4718, 0x850e, 0x40dc,
                                          0xe154, 0x5801, 0xab7d, 0x6887, 0xfd64, 0x764b, 0x6d45, 0x4767, 0xd5f1,
                                          0x7d9d, 0x74ea, 0xdf04, 0xb11d, 0xaae4, 0xc3f9, 0xdae4, 0x1bee, 0x47b6,
                                          0x6180, 0xf6da, 0xf2b1, 0x4fb3, 0x9340, 0x43f6, 0x8d50, 0x328b, 0x9902,
                                          0x35ad, 0xd1ee, 0x2d26, 0xc3fd, 0xbaea, 0x74f6, 0x646a, 0xf4fe, 0xdc53,
                                          0xd74b, 0x0e17, 0xc257, 0xea16, 0xd96a, 0xa91f, 0x949b, 0x403b, 0x4d6a,
                                          0x55cf, 0x4bb1, 0x3b1f, 0x398f, 0x25a0, 0x7e77, 0x05bb, 0x3fe3, 0x9d6d,
                                          0xb505, 0xb9c3, 0x71eb, 0x2a35, 0x6fad, 0xa92f, 0xf1c2, 0x7ad8, 0x4cce,
                                          0xac7b, 0x330c, 0x77a8, 0xe6f7, 0x8e5f, 0x692d, 0xa624, 0x6af4, 0x0f41,
                                          0xe517, 0xd968, 0x753d, 0x53eb, 0x41a0, 0xf747, 0x9bf7, 0xc47c, 0x615f,
                                          0x0f79, 0x7855, 0x588b, 0x9df3, 0x11ef, 0xd750, 0x4184, 0xe986, 0xebd2,
                                          0xcd2f, 0x9047, 0x47eb, 0xf2da, 0xedc4, 0x33ab, 0xfcec, 0x04dd, 0xf8c0,
                                          0xec4e, 0x974c, 0xed46, 0x66e6, 0xa136, 0xf206, 0x8cad, 0xae32, 0x497d,
                                          0x70ed, 0x6526, 0x7a36, 0xe314, 0x6525, 0xecf4, 0x90e1, 0xdfd0, 0x14da,
                                          0xc714, 0xe7f4, 0x5a47, 0xa18a, 0x4fd4, 0xf2e1, 0xad6f, 0xd5a2, 0x43e3,
                                          0xccc7, 0xb668, 0xb182, 0x5f27, 0xb3b8, 0xf86a, 0x1ff8, 0x19a2, 0x5c77,
                                          0x7822, 0xe85d, 0x90a4, 0xad2f, 0x28f9, 0x67af, 0x0c1b, 0x4037, 0xb053,
                                          0x87f8, 0x4fca, 0x0a89, 0xf94c, 0x39e3, 0x5588, 0x31d4, 0x23c9, 0xa3c4,
                                          0xb1f5, 0xd446, 0x1db5, 0xe900, 0xe895, 0xe614, 0x929e, 0x667a};
    uint16_t expected_rem[MAX_SIZE] = {0x100, 0x3017, 0x3d26, 0x579f, 0x97d5, 0xee6c, 0x1a63, 0x9834, 0x2445, 0xa982,
                                       0xc1a0, 0x3054, 0xe5a4, 0xc769, 0x1e61, 0xc60f, 0x8c58, 0xa184, 0x99ce, 0x98b6,
                                       0x2ad4, 0x668e, 0xbbd8, 0xc77a, 0xac53, 0x9471, 0x60fe, 0x9afa, 0x61dc, 0xee4d,
                                       0x2fa0, 0xdad6, 0x55c9, 0xa78b, 0xad23, 0x73f2, 0xdbef, 0xbcca, 0xe73f, 0xcd89,
                                       0x9b9a, 0x6916, 0x1b89, 0x240b, 0xb08f, 0x06a5, 0xb94d, 0xcb99, 0x7e65, 0xa5e4,
                                       0xc029, 0xb108, 0x1201, 0xb02c, 0xbc52, 0x2087, 0x57f7, 0x77d3, 0xd0c5, 0x590e,
                                       0xd078, 0xec11, 0xfa49, 0xa844, 0x5593, 0x414c, 0x14d8, 0x94e3, 0x2e8a, 0x3e55,
                                       0x5a0f, 0xc7b9, 0xe39a, 0x309a, 0xc894, 0xbc6b, 0x13fd, 0xf329, 0x5316, 0xf694,
                                       0x2871, 0xe59f, 0xa623, 0x9e81, 0x4ea4, 0x8a7b, 0xfe3c, 0xac7a, 0x859a, 0x3c1d,
                                       0x2776, 0xfe0d, 0xe5b6, 0xbc7b, 0x72c9, 0x404a, 0x2d35, 0x8614, 0xa8c9, 0xeb90,
                                       0xecc3, 0xe7c2, 0x675c, 0x5b60, 0x0609, 0xeec1, 0xce7e, 0x52c3, 0x00cd, 0x42f5,
                                       0x6c43, 0x76e1, 0x835f, 0x9a04, 0x6bd4, 0x7973, 0x200d, 0xb18c, 0x7e07, 0x4478,
                                       0x374e, 0x9701, 0x19d5, 0x8acc, 0x1282, 0x0f96, 0xfc7d, 0x2446, 0x4886, 0x1039,
                                       0xb589, 0xbce1, 0x4965, 0x069b, 0xa0a4, 0x504e, 0xee58, 0xf7c4, 0xdb8c, 0x1089,
                                       0xb6fc, 0x4360, 0xa8dd, 0xb61d, 0xfa79, 0x2c71, 0x6614, 0x4f35, 0x6d09, 0x7634,
                                       0xc7d6, 0xb002, 0xcc29, 0xa9a3, 0x505f, 0x03d5, 0x4e95, 0x4968, 0x5562, 0x06f1,
                                       0xf4be, 0x1138, 0xa5e1, 0x559c, 0x31e0, 0x8a1d, 0xa4bb, 0x02a7, 0x51b2, 0x03af,
                                       0xc26c, 0x626f, 0x31f4, 0x816b, 0x0c9a, 0xe69b, 0x486b, 0xae98, 0xba6e, 0xae75,
                                       0xdc89, 0x18d5, 0x48a4, 0xe0ec, 0xecbd, 0x5eac, 0xc802, 0x66d8, 0x9303, 0x1dc0,
                                       0x2499, 0x7e8b, 0xc2bc, 0x4dff, 0x9633, 0xc322, 0x0e74, 0x885a, 0x71c9, 0x01e4,
                                       0x0729, 0xb613, 0x2402, 0x01e5, 0x2967, 0x320a, 0x068b, 0xb7d8, 0x8e00, 0x76d9,
                                       0x6b5b, 0x3821, 0x7154, 0xe9be, 0x59f1, 0xec5a, 0x0093, 0xfeba, 0x9647, 0x6ec0,
                                       0x0d74, 0x72a9, 0x0d69, 0x11b4, 0x94b0, 0x0617, 0x77f6, 0xd791, 0x8a2b, 0xf059,
                                       0x770e, 0xb0cc, 0x6db7, 0x25ee, 0x1a1c, 0xa8ba, 0xa88d, 0x68e9, 0x20a4, 0xeb57,
                                       0x06b6, 0xbd62, 0xbbb5, 0xd05c, 0x7de2, 0xe92a, 0x3a85, 0xee62, 0x6b8d, 0x50b7,
                                       0x1a9f, 0xaf52, 0x5504, 0x82c0, 0xee64, 0xfe7d, 0x768f};

    mp_square(x, square);
    RUN_TEST("x^2", square, expected_square);
    mp_div(square, n, temp, out);
    RUN_TEST("x^2 mod n", out, expected_rem);
}

void test_gcd() {
    uint16_t a[MAX_SIZE] = {0x8, 0x4867, 0x3767, 0x2d60, 0xa503, 0x7fe4, 0xa540, 0xc070, 0x67e7};
    uint16_t b[MAX_SIZE] = {0x8, 0x78f9, 0x4952, 0x2293, 0xabbe, 0xb0c7, 0x2fb9, 0xe566, 0x4c4c};

    /* e = gcd(a,b) */
    uint16_t e[MAX_SIZE] = {0x1, 0x0001};
    /* f = a^{-1} mod b */
    uint16_t f[MAX_SIZE] = {0x8, 0x778c, 0x6c90, 0xa80c, 0xe431, 0x4674, 0x1b2c, 0x02a4, 0x3e99};

    binary_extended_gcd(b, a, test_array, test_array2, test_array3);
    RUN_TEST("GCD test: gcd(a,b)", test_array3, e);

    mul_inv(a, b, test_array);
    RUN_TEST("Modular inverse a^{-1} mod b", test_array, f);
}

void test_barret_reduction() {
    uint16_t p[MAX_SIZE] = {0x8, 0xda84, 0xba01, 0xf583, 0xb33d, 0xd97a, 0x865f, 0x57b4, 0x16b8};
    uint16_t q[MAX_SIZE] = {0x8, 0xcbfa, 0x5c6b, 0x8a92, 0xa8f9, 0xdf4c, 0x9055, 0xdef5, 0x213e};
    uint16_t R[MAX_SIZE] = {0x9, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0001};

    uint16_t p_mod_q[MAX_SIZE] = {0x8, 0xda84, 0xba01, 0xf583, 0xb33d, 0xd97a, 0x865f, 0x57b4, 0x16b8};
    mp_div(R, q, test_array2, test_array3);
    barret_reduction(p, q, test_array2, test_array);
    RUN_TEST("p mod q (barret reduction)", test_array, p_mod_q);
}

/* Test circular buffer for buffer_len * 120 bits (MAX 128!)*/
void test_circular_buffer(uint8_t buffer_len) {
    uint16_t data_buffer[8 * 128];
    uint8_t circular_buffer_send[240];
    uint8_t *in_ptr_send = circular_buffer_send;
    uint8_t *out_ptr_send = circular_buffer_send;
    uint8_t circular_buffer_rcv[240];
    uint8_t *in_ptr_rcv = circular_buffer_rcv;
    uint8_t *out_ptr_rcv = circular_buffer_rcv;
    uint16_t out_buffer[8];
    uint16_t i, j, recovered_count;
    uint8_t duplicate_data;

    uint16_t recovered_data_buffer[8 * 128];

    for (i = 0; i < buffer_len; i++) {
        for (j = 0; j < 8; j++) {
            if (j == 7)
                data_buffer[i * 8 + j] = (uint16_t) (rand() & 0xFFu);
            else
                data_buffer[i * 8 + j] = (uint16_t) rand();
        }
    }

#ifdef DEBUG_PRINT
    printf("\n");
    for (i = 0; i < buffer_len; i++) {
        for (j = 0; j < 8; j++) {
            printf("%04x ", data_buffer[i*8 + j]);
        }
        printf("\n");
    }
#endif

    recovered_count = 0;

    for (i = 0; i < buffer_len; i++) {
        if (circular_buffer_append_15(&data_buffer[8 * i], circular_buffer_send, &in_ptr_send, &out_ptr_send,
                                      out_buffer)) {
#ifdef DEBUG_PRINT
            for (j = 0; j < 8; j++) {
                printf("%04x ", out_buffer[j]);
            }
            printf("\n");
#endif
            duplicate_data = circular_buffer_append_16(out_buffer, circular_buffer_rcv, &in_ptr_rcv, &out_ptr_rcv,
                                                       &recovered_data_buffer[8 * recovered_count]);
            recovered_count++;
            if (duplicate_data)
                recovered_count++;
        }
    }

    if (circular_buffer_is_residual(circular_buffer_send, in_ptr_send)) {
        circular_buffer_get_residual(circular_buffer_send, in_ptr_send, out_ptr_send, out_buffer);
#ifdef DEBUG_PRINT
        for (j = 0; j < 8; j++) {
            printf("%04x ", out_buffer[j]);
        }
        printf("\n");
#endif
        duplicate_data = circular_buffer_append_16(out_buffer, circular_buffer_rcv, &in_ptr_rcv, &out_ptr_rcv,
                                                   &recovered_data_buffer[8 * recovered_count]);
        recovered_count++;
        if (duplicate_data)
            recovered_count++;
    }

#ifdef DEBUG_PRINT
        printf("\n");
        for (i = 0; i < recovered_count; i++) {
            for (j = 0; j < 8; j++) {
                printf("%04x ", recovered_data_buffer[i*8 + j]);
            }
            printf("\n");
        }
#endif
    RUN_TEST_ARR("Circular buffer test", recovered_data_buffer, data_buffer, (size_t) buffer_len * 16);
}

void test_gcm() {
    aes_key key;

    uint16_t i, j;

    uint16_t buffer_len = 80;
    uint8_t circular_buffer_send[240]; /* Circular buffer for data from encoding -> encryption */
    uint8_t *in_ptr_send = circular_buffer_send;  /* pointers for circular buffer */
    uint8_t *out_ptr_send = circular_buffer_send;
    uint8_t send_data[16]; /* buffer for data -> encryption */
    uint8_t circular_buffer_rcv[240];  /* Circular buffer for data from handle_packet -> decoding */
    uint8_t *in_ptr_rcv = circular_buffer_rcv;  /* pointers for circular buffer */
    uint8_t *out_ptr_rcv = circular_buffer_rcv;

    uint16_t data_buffer[16 * 128]; /* 128 * 120 bits (128 * 40 samples) */
    uint16_t recovered_data_buffer[16 * 128];
    uint8_t data_ready;
    uint8_t duplicate_data;
    uint16_t recovered_count = 0;

    uint8_t iv[12];
    uint8_t Y[16] = {0x00};
    uint16_t H[8];
    uint16_t T0[8];
    uint8_t Ci[16] = {0x00};
    uint16_t T[8];
    uint8_t packet_1[17];
    uint8_t packet_int[21];
    uint8_t packet_last[21];
    uint8_t recovered_plaintext[16];
    uint8_t lenC[16] = {0x00};

    long seed = time(NULL);
    srand((uint32_t) seed);

    for (i = 0; i < buffer_len; i++) {
        for (j = 0; j < 8; j++) {
            if (j == 7)
                data_buffer[i * 8 + j] = (uint16_t) (rand() & 0xFFu);
            else
                data_buffer[i * 8 + j] = (uint16_t) rand();
        }
    }

#ifdef DEBUG_PRINT
    printf("\n");
    for (i = 0; i < buffer_len; i++) {
        for (j = 0; j < 8; j++) {
            printf("%04x ", data_buffer[i*8 + j]);
        }
        printf("\n");
    }
#endif

    aes_set_encrypt_key(&key, (const uint8_t *) "\xfe\xf9\xe9\x92\x86\x65\x73\x1c\x7d\x6a\x8f\x94\x67\x30\x83\x08",
                        128);

    /* INITIALIZATION */
    for (i = 0; i < 12; i++) {
        iv[i] = (uint8_t) rand();
    }
    initialization(Y, iv, &key, H, T0, T);
    pack_data_first(Y, packet_1);
    handle_packet(packet_1, &key, NULL);

    /* ENCRYPTION AND DECRYPTION CHAIN OF PLAINTEXTS */
#ifdef DEBUG_PRINT
    printf("Recovered Plain text : \n");
#endif

    for (i = 0; i < buffer_len; i++) {
        data_ready = circular_buffer_append_15(&data_buffer[8 * i], circular_buffer_send, &in_ptr_send, &out_ptr_send,
                                               (uint16_t *) send_data);
        if (data_ready) {
            gcm_encrypt(H, send_data, Ci, Y, &key, T);
            pack_data_int(Y, Ci, packet_int);
            increment_lenC(lenC);
            handle_packet(packet_int, &key, recovered_plaintext);

            duplicate_data = circular_buffer_append_16((uint16_t *) recovered_plaintext, circular_buffer_rcv,
                                                       &in_ptr_rcv,
                                                       &out_ptr_rcv, &recovered_data_buffer[8 * recovered_count]);
            recovered_count++;
            if (duplicate_data)
                recovered_count++;
        }
    }

    if (circular_buffer_is_residual(circular_buffer_send, in_ptr_send)) {
        circular_buffer_get_residual(circular_buffer_send, in_ptr_send, out_ptr_send, (uint16_t *) send_data);
#ifdef DEBUG_PRINT
        for (j = 0; j < 8; j++) {
            printf("%04x ", out_buffer[j]);
        }
        printf("\n");
#endif
        gcm_encrypt(H, send_data, Ci, Y, &key, T);
        pack_data_int(Y, Ci, packet_int);
        increment_lenC(lenC);
        handle_packet(packet_int, &key, recovered_plaintext);

        duplicate_data = circular_buffer_append_16((uint16_t *) recovered_plaintext, circular_buffer_rcv, &in_ptr_rcv,
                                                   &out_ptr_rcv, &recovered_data_buffer[8 * recovered_count]);
        recovered_count++;
        if (duplicate_data)
            recovered_count++;
    }

    tag(T, lenC, T0, H);
    pack_data_last(Y, (uint8_t *) T, packet_last);
    handle_packet(packet_last, &key, NULL);

    RUN_TEST_ARR("GCM test", recovered_data_buffer, data_buffer, (size_t) buffer_len * 16);
}

int main(void) {
    /* Test circular buffer */
    test_circular_buffer(120);
    test_circular_buffer(96); /* multiple of 16 elements */
    test_gcm();
    /* Test of Blum-blum-shub PRNG */
    test_bbs();
    /* Full test of Station to Station protocol */
    test_sts();

    test_addition();
    test_subtraction();
    test_multiplication();
    test_division();
    test_gcd();
    test_square_mod_n();
    test_montgomery();
    return 0;
}